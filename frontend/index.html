<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>polycode | Learn • Code • Execute</title>
  <link rel="icon" href="./assets/logo.png" />
  <meta name="color-scheme" content="dark light" />
  <script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-auth-compat.js"></script>
  <style>
    /* (your CSS unchanged) */
  </style>
</head>
<body>
  <!-- (header, hero, footer, modal unchanged) -->

  <script>
    const $ = (sel, root=document) => root.querySelector(sel);
    const $$ = (sel, root=document) => [...root.querySelectorAll(sel)];

    const DEV_MODE = false; // using Firebase now

    const toE164 = (cc, raw) => {
      const digits = String(raw).replace(/\D+/g, '');
      if(digits.length < 7 || digits.length > 15) return null;
      return cc + digits;
    };
    const maskPhone = (e164) => e164.replace(/(\+\d{1,3})(\d{2,4})(.*)(\d{3})$/, (_,c,a,mid,z) => `${c} ${a}••• ${z}`);

    let countdown=null, seconds=60, phoneE164=null;

    const modal=$('#otpModal');
    const openModal=()=>modal.classList.add('open');
    const closeModal=()=>{modal.classList.remove('open'); resetFlow();};
    $$('[data-close]').forEach(b=>b.addEventListener('click',closeModal));

    $('#btnLogin').addEventListener('click',openModal);
    $('#btnLoginHero').addEventListener('click',openModal);
    $('#yr').textContent=new Date().getFullYear();

    const stepPhone=$('#stepPhone');
    const stepOtp=$('#stepOtp');
    const otpGrid=$('#otpGrid');
    for(let i=0;i<6;i++){const inp=document.createElement('input');inp.type='text';inp.inputMode='numeric';inp.maxLength=1;inp.autocomplete='one-time-code';inp.addEventListener('input',(e)=>{e.target.value=e.target.value.replace(/\D/g,'');if(e.target.value&&i<5)otpGrid.children[i+1].focus();});inp.addEventListener('keydown',(e)=>{if(e.key==='Backspace'&&!e.target.value&&i>0)otpGrid.children[i-1].focus();});otpGrid.appendChild(inp);}

    // ==== Firebase init (use your config) ====
    const firebaseConfig = {
      apiKey: "AIzaSyBuAuNBOM-5m6ZDPiR2YwmQaZHYHhtLW1c",
      authDomain: "polycode-5551e.firebaseapp.com",
      projectId: "polycode-5551e",
      storageBucket: "polycode-5551e.firebasestorage.app",
      messagingSenderId: "795416117892",
      appId: "1:795416117892:web:67f10f7819a09c6c55f8d1",
      measurementId: "G-BWTXJSZXVX"
    };
    if(!firebase.apps.length) firebase.initializeApp(firebaseConfig);
    const auth=firebase.auth();
    let recaptchaVerifier;
    window.addEventListener('load',()=>{try{recaptchaVerifier=new firebase.auth.RecaptchaVerifier('btnSendOtp',{size:'invisible'});}catch{}});

    stepPhone.addEventListener('submit',async(e)=>{
      e.preventDefault();
      $('#phoneErr').style.display='none';
      const[,ccCode]=$('#country').value.split(':');
      const e164=toE164(ccCode,$('#phone').value);
      if(!e164){$('#phoneErr').textContent='Enter a valid phone number.';$('#phoneErr').style.display='block';return;}
      phoneE164=e164;
      try{
        window.confirmationResult=await auth.signInWithPhoneNumber(e164,recaptchaVerifier);
      }catch(err){$('#phoneErr').textContent=(err&&err.message)||'Could not send OTP.';$('#phoneErr').style.display='block';return;}
      $('#otpTo').textContent=maskPhone(e164);
      $('#stepSubtitle').textContent='Step 2 of 2: Enter the OTP';
      stepPhone.style.display='none';stepOtp.style.display='block';otpGrid.children[0].focus();
      seconds=60;updateTimer();$('#btnResend').disabled=true;countdown=setInterval(()=>{seconds--;updateTimer();if(seconds<=0){clearInterval(countdown);$('#btnResend').disabled=false;}},1000);
    });

    function updateTimer(){const m=String(Math.floor(seconds/60)).padStart(2,'0');const s=String(seconds%60).padStart(2,'0');$('#timer').textContent=`${m}:${s}`;}

    $('#btnResend').addEventListener('click',async()=>{
      try{window.confirmationResult=await auth.signInWithPhoneNumber(phoneE164,recaptchaVerifier);}catch(err){showOtpErr((err&&err.message)||'Could not resend OTP.');return;}
      seconds=60;updateTimer();$('#btnResend').disabled=true;clearInterval(countdown);countdown=setInterval(()=>{seconds--;updateTimer();if(seconds<=0){clearInterval(countdown);$('#btnResend').disabled=false;}},1000);
      otpGrid.children[0].focus();$$('#otpGrid input').forEach(i=>i.value='');$('#otpErr').style.display='none';
    });

    $('#btnBack').addEventListener('click',()=>{clearInterval(countdown);stepOtp.style.display='none';stepPhone.style.display='block';$('#stepSubtitle').textContent='Step 1 of 2: Verify your number';$('#phone').focus();$('#otpErr').style.display='none';});

    stepOtp.addEventListener('submit',async(e)=>{
      e.preventDefault();
      const code=$$('#otpGrid input').map(i=>i.value).join('');
      if(code.length!==6){showOtpErr('Enter the 6-digit code.');return;}
      if(seconds<=0){showOtpErr('OTP expired.');return;}
      try{const cred=await window.confirmationResult.confirm(code);const phone=(cred&&cred.user&&cred.user.phoneNumber)||phoneE164;localStorage.setItem('polycode_auth',JSON.stringify({phone,ts:Date.now()}));applyLoggedIn();closeModal();}catch(err){showOtpErr((err&&err.message)||'Incorrect code.');}}
    );

    function showOtpErr(msg){const el=$('#otpErr');el.textContent=msg;el.style.display='block';}

    function applyLoggedIn(){const raw=localStorage.getItem('polycode_auth');const chip=$('#userChip');if(!raw){chip.style.display='none';$('#btnLogin').style.display='inline-flex';return;}try{const{phone}=JSON.parse(raw);$('#chipMeta').textContent=maskPhone(phone);chip.style.display='inline-flex';$('#btnLogin').style.display='none';}catch{chip.style.display='none';$('#btnLogin').style.display='inline-flex';}}

    function resetFlow(){clearInterval(countdown);seconds=60;updateTimer();stepOtp.style.display='none';stepPhone.style.display='block';$('#stepSubtitle').textContent='Step 1 of 2: Verify your number';$('#phoneErr').style.display='none';$('#otpErr').style.display='none';$$('#otpGrid input').forEach(i=>i.value='');attempts=0;phoneE164=null;}

    $('#btnLogout').addEventListener('click',()=>{localStorage.removeItem('polycode_auth');applyLoggedIn();});
    applyLoggedIn();
    modal.addEventListener('click',(e)=>{if(e.target.matches('[data-close]'))closeModal();});
    document.addEventListener('keydown',(e)=>{if(e.key==='Escape'&&modal.classList.contains('open'))closeModal();});
  </script>
</body>
</html>
