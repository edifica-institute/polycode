<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />

  <title>polycode | Java</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="icon" href="./assets/logo.png" />
  <link rel="stylesheet" href="./css/shell.css" />
  <link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>
  <meta name="color-scheme" content="dark light" />

  <style>
    /* kill any token-like styling on the input row */
    #consoleRow span {
      background: transparent !important;
      padding: 0 !important;
      border-radius: 0 !important;
    }

    /* make the input caret clean, no borders/outline */
    #consoleInput {
      display: inline-block;
      min-width: 5ch;
      background: transparent;
      border: 0;
      outline: 0;
      box-shadow: none;
      caret-color: currentColor;
      user-select: text;
      -webkit-user-modify: read-write-plaintext-only;
    }
    #consoleInput:focus { outline: 0; }
    #consoleInput::selection { background: rgba(255, 255, 255, 0.15); } /* optional */

    /* stop all attention animations once disabled */
    .btn[disabled],
    .btn.attn[disabled] { animation: none !important; }

    .pane-foot .msg { white-space: nowrap; }
    .panel .pane-head { display:flex; align-items:center; }

    /* --- Complexity modal + table --- */
    .pc-modal { position: fixed; inset: 0; display: none; z-index: 1000; }
    .pc-modal[aria-hidden="false"] { display:block; }
    .pc-modal__backdrop{ position:absolute; inset:0; background:rgba(0,0,0,.45); }
    .pc-modal__dialog{
      position:relative; margin:5vh auto; max-width:800px; background:var(--panel, #111);
      color:inherit; border:1px solid rgba(255,255,255,.1); border-radius:14px;
      box-shadow:0 20px 50px rgba(0,0,0,.35); padding:14px;
    }
    .pc-modal__header{ display:flex; align-items:center; justify-content:space-between; }
    .pc-modal__close{ background:transparent; border:0; font-size:22px; cursor:pointer; }
    .pc-modal__body{ max-height:60vh; overflow:auto; }
    .pc-modal__footer{ display:flex; justify-content:flex-end; gap:8px; }
    .cx-summary{ display:grid; grid-template-columns:1fr 1fr; gap:10px; margin:6px 0 10px; }
    .cx-table{ width:100%; border-collapse: collapse; font:13px/1.4 ui-monospace, Menlo, Consolas, monospace; }
    .cx-table th, .cx-table td{ border-bottom:1px solid rgba(127,127,127,.25); padding:6px 8px; vertical-align: top; }
    .cx-table th{ text-align:left; position:sticky; top:0; background:inherit; }
    .cx-notes{ opacity:.9; font-size:12px; margin-top:8px; }

    /* Icon hygiene */
    #btnComplexity svg{ display:block; }
    #btnComplexity .sr-only{
      position:absolute; width:1px; height:1px; margin:-1px; overflow:hidden; clip:rect(0 0 0 0); white-space:nowrap; border:0;
    }

   

    
    /* One-time subtle pulse when the button first unlocks */
    @media (prefers-reduced-motion: no-preference) {
      @keyframes pc-pulse-brief {
        0%   { transform: scale(1); }
        40%  { transform: scale(1.08); }
        100% { transform: scale(1); }
      }
      .btn-pulse { animation: pc-pulse-brief 0.9s ease-out; }
    }
  </style>
</head>

<body class="page-fade">
  <!-- Header -->
  <header class="site-header">
    <div class="brand-wrap">
      <div class="brand-grid">
        <img
          src="./assets/PC-Logo.png"
          alt="polycode"
          class="brand-logo"
          loading="lazy"
          decoding="async"
        />
        <div class="brand-title2">polycode</div>
        <div class="brand-tagline2">
          learn<span class="dot">.</span>code<span class="dot">.</span>execute
        </div>
      </div>
    </div>

    <nav class="site-nav">
      <a href="./index.html">Home</a>
      <a href="./about.html">About</a>
      <a href="./contact.html">Contact</a>
    </nav>
  </header>

  <!-- App -->
 <main class="stage" role="main">
    <div class="app">
      <!-- LEFT panel -->
      <section class="panel left" id="leftPanel">
        <div class="pane-head">
          <select
            id="langSelect"
            class="select"
            aria-label="Choose language"
            onchange="location.href=this.value" disabled
          >
            
            <option value="./index-java.html" selected>Java</option>
            <option value="./index-c.html">C</option>
            <option value="./index-cpp.html">C++</option>
             <option value="./index-web.html">HTML/CSS/JS</option>
            <option value="./index-python.html">Python</option>
            <option value="scratch">Scratch</option>

            <option value="./index-sql.html">SQL (MySQL/SQLite)</option>
           
          </select>
          <div class="right-controls">
      <!-- existing left controls… -->
      <button class="btn expander" onclick="toggleExpand('left', this)" aria-pressed="false" title="Expand Left panel">⤢</button>
    </div>

        </div>
        <div class="pane-scroll">

        <div class="pane-body">
          <div id="leftContent" style="margin-top:12px;"></div>
        </div>
        <div class="pane-foot">
          <span class="msg" id="leftFoot">About Java</span>
        </div>
        </div>
      </section>

   

      <!-- CENTER panel (Editor) -->
      <section class="panel center" id="centerPanel">
        <div class="pane-head">

             <button id="btnToggleLeft"  class="btn btn-toggle" aria-pressed="false"  title="Show/Hide Left Panel">
  <!-- sidebar-left icon -->
  <svg viewBox="0 0 24 24" width="18" height="18" aria-hidden="true">
    <rect x="3" y="4" width="6" height="16" rx="1" />
    <rect x="10" y="4" width="11" height="16" rx="1" fill="none" stroke="currentColor" stroke-width="2"/>
  </svg>
</button>
          <button
            id="themeToggle"
            class="btn theme-btn"
            title="Toggle theme"
            aria-label="Toggle theme"
          >
            <svg viewBox="0 0 24 24" id="themeIcon">
              <path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z" />
            </svg>
          </button>

         

          <div class="right-controls" style="margin-left:auto; display:flex; gap:8px; align-items:center;">

            <button id="btnToggleRight" class="btn btn-toggle" aria-pressed="true"  title="Show/Hide Output Panel" hidden>
  <!-- terminal/output icon -->
  <svg viewBox="0 0 24 24" width="18" height="18" aria-hidden="true">
    <rect x="3" y="4" width="18" height="16" rx="2" fill="none" stroke="currentColor" stroke-width="2"/>
    <path d="M7 9l3 3-3 3M12 15h5" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"/>
  </svg>
</button>

            
           <button id="btnSaveFile" class="btn" title="Capture & Share (Ctrl/Cmd+S)" aria-label="Capture & Share">
  <svg viewBox="0 0 24 24" width="18" height="18" aria-hidden="true">
    <!-- camera frame -->
    <rect x="3" y="6" width="18" height="13" rx="2" ry="2"
          fill="none" stroke="currentColor" stroke-width="2"/>
    <!-- top bar / notch -->
    <path d="M9 6l1.5-2h3L15 6" fill="none" stroke="currentColor" stroke-width="2"/>
    <!-- focus dot -->
    <circle cx="12" cy="12" r="2.5" fill="currentColor"/>
  </svg>
</button>


            <button
              id="btnSharePdf"
              class="btn"
              title="Share PDF"
              aria-label="Share PDF"
            >
              <svg viewBox="0 0 24 24">
                <path
                  d="M4 12v8a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-8h-2v8H6v-8H4zm8-10-5.5 5.5L8.91 9 11 6.91V16h2V6.91L15.09 9l2.41-1.5L12 2z"
                  fill="currentColor"
                />
              </svg>
            </button>

            <button
              id="btnRun"
              class="btn primary attn"
              title="Execute (Click or Press F9)"
              aria-label="Run"
            >
              <svg viewBox="0 0 24 24">
                <path d="M8 5v14l11-7z" />
              </svg>
            </button>
          </div>
        </div>
<div class="pane-scroll">

        <div id="editor"></div>

        <div class="pane-foot">
          <span class="msg" id="centerFoot">Ready for Execution</span>
        </div>
</div>
      </section>

     

      <!-- RIGHT panel (Console) -->
      <section class="panel right" id="rightPanel">
        <div class="pane-head">
          
          <div class="right-controls" style="margin-left:auto; display:flex; align-items:center;">
             <button class="btn expander" onclick="toggleExpand('right', this)" aria-pressed="false" title="Expand Output">⤢</button>

            <button id="btnComplexity" class="btn" title="Analyze Time & Space" aria-label="Complexity" disabled>
              <svg viewBox="0 0 24 24" width="18" height="18" aria-hidden="true">
                <circle cx="12" cy="12" r="7" fill="none" stroke="currentColor" stroke-width="2"/>
                <path d="M9 9.5c.9-1 2-1.5 3-1.5s2.1.5 3 1.5" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
              </svg>
              <span class="sr-only">Complexity</span>
            </button>

            <button
              id="btnReset"
              class="btn"
              title="Reset (Click or Press F10)"
              aria-label="Reset">
              <svg viewBox="0 0 24 24">
                <path d="M12 6v3l4-4-4-4v3C7.58 4 4 7.58 4 12s3.58 8 8 8a8 8 0 007.39-4.91l-1.85-.77A6 6 0 1112 6z" />
              </svg>
            </button>
          </div>
        </div>
<div class="pane-scroll">

        <div id="output" class="screen-dim" style="padding:12px;">
          <!-- Output only -->
          <pre id="jconsole" class="console" style="margin:0; white-space:pre-wrap;"></pre>

          <!-- Input row (shown only when needed) -->
          <div
            id="consoleRow"
            style="display:none; margin-top:0; gap:4px; align-items:baseline; font:14px/1.4 ui-monospace, Menlo, Consolas, monospace;"
          >
            <span id="consolePrefix"></span>
            <span id="consoleInput" contenteditable="true" spellcheck="false"></span>
          </div>


 <pre id="stderrText" class="console-block error" aria-label="Compiler Errors"></pre>
            <!-- NEW: explanations will be injected here -->
            <div id="stderrExplain" class="console-explain" aria-live="polite"></div>
          
        </div>

        <div class="pane-foot">
          <span class="msg" id="rightFoot">Waiting for Execution</span>
        </div>
</div>
      </section>
    </div>
  </main>

 

  <!-- Footer -->

<footer class="site-footer">
  <div class="footer-grid">
    <!-- Left: Edifica logo + powered + slogan -->
    <div class="footer-left">
      <img src="./assets/logo.png" alt="Edifica" class="footer-logo" />
      <div class="txt">
        <span class="powered">powered by edifica</span>
       <span class="subline">
  education<span class="dot">.</span>consultation<span class="dot">.</span>assistance
</span>
<div class="siteurl">
  <a href="https://www.edifica.in" target="_blank" rel="noopener">www.edifica.in</a>
</div>

        
      </div>
    </div>

    <!-- Center: Follow us + icons (auto colors by theme) -->
    <div class="footer-center">
      <span class="label">Follow us</span>
      <a class="social" href="https://facebook.com/edifica.facebook" target="_blank" rel="noopener" aria-label="Facebook" title="Facebook">
        <!-- FB -->
        <svg viewBox="0 0 24 24" width="18" height="18"><path d="M22 12.07C22 6.48 17.52 2 11.93 2S2 6.48 2 12.07c0 5.01 3.66 9.16 8.44 9.93v-7.03H7.9v-2.9h2.54V9.41c0-2.5 1.49-3.89 3.77-3.89 1.09 0 2.24.2 2.24.2v2.47h-1.26c-1.24 0-1.63.77-1.63 1.56v1.88h2.78l-.44 2.9h-2.34v7.03C18.34 21.23 22 17.08 22 12.07z"/></svg>
      </a>
      <a class="social" href="https://instagram.com/edifica.ig" target="_blank" rel="noopener" aria-label="Instagram" title="Instagram">
        <!-- IG -->
        <svg viewBox="0 0 24 24" width="18" height="18"><path d="M7 2h10a5 5 0 0 1 5 5v10a5 5 0 0 1-5 5H7a5 5 0 0 1-5-5V7a5 5 0 0 1 5-5zm5 5a5 5 0 1 0 0 10 5 5 0 0 0 0-10zm6.5-.5a1.5 1.5 0 1 0 0 3 1.5 1.5 0 0 0 0-3zM12 9.5A2.5 2.5 0 1 1 9.5 12 2.5 2.5 0 0 1 12 9.5z"/></svg>
      </a>
      <a class="social" href="https://youtube.com/@edifica.youtube" target="_blank" rel="noopener" aria-label="YouTube" title="YouTube">
        <!-- YT -->
        <svg viewBox="0 0 24 24" width="18" height="18"><path d="M23.5 6.2a3 3 0 0 0-2.1-2.1C19.4 3.5 12 3.5 12 3.5s-7.4 0-9.4.6A3 3 0 0 0 .5 6.2 31.7 31.7 0 0 0 0 12a31.7 31.7 0 0 0 .6 5.8 3 3 0 0 0 2.1 2.1c2 .6 9.3.6 9.3.6s7.4 0 9.4-.6a3 3 0 0 0 2.1-2.1c.4-1.9.6-3.9.6-5.8 0-1.9-.2-3.9-.6-5.8zM9.6 15.5V8.5L16 12l-6.4 3.5z"/></svg>
      </a>
    </div>

    <!-- Right: legal links (now underlined) -->
    <div class="footer-right">
      <a href="./privacy.html">Privacy Policy</a>
      <a href="./terms.html">Terms &amp; Conditions</a>
      <a href="./legal.html">Legal Information</a>
    </div>
  </div>
</footer>










  

  <!-- Scripts -->
  <script src="https://cdn.jsdelivr.net/npm/monaco-editor@0.45.0/min/vs/loader.min.js" defer></script>
  <script src="./js/shell.js" defer></script>

  <!-- Page script -->
  <script>
    /* --- Sample Java used in the editor --- */
    const SAMPLE_JAVA =
`class Main {
  public static void main(String[] args) {
    System.out.println("Hello Java!");
  }
}`;

    /* --- Make bootstrap globally visible --- */
    window.bootstrap = async function bootstrap() {
      await window.PolyShell.initMonaco({ value: SAMPLE_JAVA, language: 'java' });
      window.PolyShell.setStatus('Ready', 'ok');
      window.PolyShell.loadLeftContent('java'); // loads /content/java.html into left pane (optional)
    };

    // ===== Input-wait countdown =====
    let __inputDeadline = 0;          // epoch ms when input wait expires
    let __inputCountdownTimer = null; // interval handle

    function getCountdownText() {
      if (!__inputDeadline) return '';
      const ms = Math.max(0, __inputDeadline - Date.now());
      const s  = Math.floor(ms / 1000);
      const mm = String(Math.floor(s / 60)).padStart(2, '0');
      const ss = String(s % 60).padStart(2, '0');
      return ` — ${mm}:${ss}`;
    }

    function startInputCountdown(ms) {
      stopInputCountdown();
      __inputDeadline = Date.now() + Math.max(0, Number(ms) || 0);
      __inputCountdownTimer = setInterval(() => {
        // status refreshed by startStatusDots interval
      }, 500);
    }

    function stopInputCountdown() {
      __inputDeadline = 0;
      if (__inputCountdownTimer) {
        clearInterval(__inputCountdownTimer);
        __inputCountdownTimer = null;
      }
    }

    // --- UI: animated dots in status ---
    let __statusTimer = null;
    let __statusBase  = '';
    // Track intentional closes (Reset)
    window.__closingByUser = false;

    function startStatusDots(baseText) {
      stopStatusDots();
      __statusBase = baseText || 'Executing';
      let dots = 0;
      __statusTimer = setInterval(() => {
        dots = (dots + 1) % 4; // 0..3
        const statusEl = document.getElementById('statusDots');
        if (statusEl) statusEl.textContent = __statusBase + '.'.repeat(dots) + getCountdownText();
      }, 400);
    }

    function stopStatusDots() {
      if (__statusTimer) {
        clearInterval(__statusTimer);
        __statusTimer = null;
      }
    }

    function printToConsole({ compileErr = '', stderr = '', stdout = '', exitCode = null }) {
      const el = document.getElementById('jconsole');
      if (!el) return;
      const parts = [];
      if (compileErr.trim()) parts.push(compileErr.trim());
      if (stderr.trim())     parts.push(stderr.trim());
      if (stdout.trim())     parts.push(stdout.trim());
      if (exitCode != null && exitCode !== 0) parts.push(`Exit code: ${exitCode}`);
      el.textContent = parts.join('\n') + (parts.length ? '\n' : '');
      document.getElementById('output')?.scrollTo({ top: 1e9, behavior: 'smooth' });
    }

    function findJavaErrorLine(text, className) {
      const fileRe = `${className}.java`.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
      let m = new RegExp(fileRe + ':(\\d+):').exec(text);   // Foo.java:5:
      if (m) return Number(m[1]);
      m = new RegExp(fileRe + ':(\\d+)\\)').exec(text);     // Foo.java:12)
      if (m) return Number(m[1]);
      return 1;
    }

    let __pistonJavaVersion = null;
    async function getPistonJavaVersion(forceRefresh = false) {
      if (!forceRefresh && __pistonJavaVersion) return __pistonJavaVersion;
      try {
        const resp = await fetch('https://emkc.org/api/v2/piston/runtimes');
        const runtimes = await resp.json();
        const java = runtimes.find(r => r.language === 'java')
          || runtimes.find(r => /open.?jdk/i.test(r.language))
          || runtimes.find(r => /java/i.test(r.language));
        __pistonJavaVersion = java?.version || '21';
      } catch {
        __pistonJavaVersion = '21';
      }
      return __pistonJavaVersion;
    }

    async function pistonExecuteJava({ code, fileName, version, stdin = '' }) {
      const body = JSON.stringify({
        language: 'java',
        version,
        files: [{ name: fileName, content: code }],
        stdin
      });
      const resp = await fetch('https://emkc.org/api/v2/piston/execute', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body
      });
      const text = await resp.text();
      let data = null;
      try {
        if ((resp.headers.get('content-type') || '').toLowerCase().includes('application/json')) {
          data = JSON.parse(text);
        }
      } catch {}
      return { ok: resp.ok, status: resp.status, text, data };
    }

    // Pull stdin from special comments in the code and remove them before compile
    function extractInlineStdin(code) {
      let stdin = '';

      // Multi-line /* stdin: ... */
      const block = /\/\*\s*(stdin|input)\s*[:=]\s*([\s\S]*?)\*\//i;
      code = code.replace(block, (_, __, content) => {
        stdin = content.replace(/^\s*\* ?/gm, '');
        return '';
      });

      // Single-line // stdin: 42\n99
      if (!stdin) {
        const line = /^\s*\/\/\s*(stdin|input)\s*[:=]\s*(.*)$/mi;
        const m = code.match(line);
        if (m) {
          stdin = m[2].replace(/\\n/g, '\n');
          code = code.replace(line, '');
        }
      }

      return { code: code.trim(), stdin: stdin.replace(/\r\n?/g, '\n') };
    }

    function detectClassToRun(code) {
      let m = code.match(/\bpublic\s+class\s+([A-Za-z_]\w*)\b/);
      if (m) return m[1];
      m = code.match(/\bclass\s+([A-Za-z_]\w*)\b[\s\S]*?\bpublic\s+static\s+void\s+main\s*\(/);
      if (m) return m[1];
      return 'Main';
    }

    (function () {
      const JAVA_WS_URL = 'wss://polycode-java.onrender.com/java';

      // Make WS handles global so pre-connect can see them safely
      window.termWS = window.termWS || null;
      window.wsRunInFlight = window.wsRunInFlight || false;

      // ---- Console helpers for this IIFE ----
      function setConsole(text) {
        const el = document.getElementById('jconsole');
        if (!el) return;
        el.textContent = text || '';
        document.getElementById('output')?.scrollTo({ top: 1e9 });
      }

      // Complexity button enable/disable with one-time pulse
      function setComplexityEnabled(on){
        const b = document.getElementById('btnComplexity');
        if (!b) return;
        const wasDisabled = b.disabled;
        b.disabled = !on;
        if (on && wasDisabled && !b.dataset.pulsedOnce) {
          b.classList.add('btn-pulse');
          b.dataset.pulsedOnce = '1';
          setTimeout(() => b.classList.remove('btn-pulse'), 1000);
        }
      }
      window.setComplexityEnabled = setComplexityEnabled;

      function termWrite(t) {
        const el = document.getElementById('jconsole');
        if (el) {
          el.textContent += t;
          document.getElementById('output')?.scrollTo({ top: 1e9 });
        }
      }

      // ---- Minimal input line (NO '$' prompt) ----
      function focusConsoleInput() {
        const el = document.getElementById('consoleInput');
        if (!el) return;
        el.focus();
        const r = document.createRange();
        r.selectNodeContents(el);
        r.collapse(false);
        const s = window.getSelection();
        s.removeAllRanges();
        s.addRange(r);
      }

      function showInputRow(show) {
        const row    = document.getElementById('consoleRow');
        const pre    = document.getElementById('jconsole');
        const prefix = document.getElementById('consolePrefix');

        if (row) row.style.display = show ? 'flex' : 'none';

        if (show) {
          const txt  = pre.textContent;
          const i    = txt.lastIndexOf('\n');
          const tail = txt.slice(i + 1);
          if (tail && !/^\s*$/.test(tail)) {
            prefix.textContent = tail + ' ';
            pre.textContent = txt.slice(0, i + 1);
          } else {
            prefix.textContent = '';
          }

          window.PolyShell?.setStatus('Waiting for User Input...', 'busy');

          __statusBase = 'Waiting for User Input';
          startStatusDots(__statusBase);
          startInputCountdown(inputWaitMs);

          const el = document.getElementById('consoleInput');
          if (el) {
            el.focus();
            const r = document.createRange();
            r.selectNodeContents(el);
            r.collapse(false);
            const s = window.getSelection();
            s.removeAllRanges();
            s.addRange(r);
          }
        } else {
          if (typeof window.wsRunInFlight !== 'undefined' && window.wsRunInFlight) {
            window.PolyShell?.setStatus('Executing...', 'busy');
          }
          if (prefix.textContent) {
            pre.textContent += prefix.textContent;
            prefix.textContent = '';
          }
        }
      }

      /* --- Monaco marker helpers --- */
      function clearEditorMarkers() {
        if (!window.monaco || !window.editor) return;
        const model = window.editor.getModel();
        if (model) window.monaco.editor.setModelMarkers(model, 'javac', []);
      }

      function setEditorMarker(line, message) {
        if (!window.monaco || !window.editor) return;
        const model = window.editor.getModel();
        if (!model) return;
        const maxCol = Math.max(1, model.getLineMaxColumn(line || 1));
        window.monaco.editor.setModelMarkers(model, 'javac', [{
          startLineNumber: line || 1,
          endLineNumber:   line || 1,
          startColumn:     1,
          endColumn:       maxCol,
          message:         String(message || 'Error'),
          severity:        window.monaco.MarkerSeverity.Error
        }]);
      }

      // ---- Input detection ----
      function codeNeedsInput(code) {
        const hasScanner = /\bnew\s+Scanner\s*\(\s*System\.in\s*\)/s.test(code);
        const usesNext   = /\b(\w+)\s*=\s*new\s+Scanner\s*\(\s*System\.in\s*\)[\s\S]*?\b\1\s*\.\s*next(?:Line|Int|Double|Long|Short|Float)?\s*\(/s.test(code)
                        || /\bScanner\b[\s\S]*?\.\s*next(?:Line|Int|Double|Long|Short|Float)?\s*\(/s.test(code);
        return hasScanner && usesNext;
      }

      // ---- Gentle WS connect + wake ping ----
      async function wakeRunner() {
        try { await fetch('https://polycode-java.onrender.com/health', { cache: 'no-store', mode: 'no-cors' }); } catch {}
      }

      function tryConnectWS(timeoutMs = 8000) {
        return new Promise((resolve) => {
          let done = false;
          let timer = null;
          let ws;
          try {
            ws = new WebSocket(JAVA_WS_URL);
          } catch {
            return resolve(null);
          }
          const finish = (ok) => {
            if (done) return;
            done = true;
            clearTimeout(timer);
            ws.onopen = ws.onerror = ws.onclose = null;
            resolve(ok ? ws : null);
          };
          timer = setTimeout(() => finish(false), timeoutMs);
          ws.onopen  = () => finish(true);
          ws.onerror = () => finish(false);
          ws.onclose = () => finish(false);
        });
      }

      // ---- Send input when user presses Enter ----
      document.addEventListener('keydown', (e) => {
        const el = document.getElementById('consoleInput');
        if (!el || el.offsetParent === null) return;
        if (e.target !== el) return;

        if (e.key === 'Enter') {
          e.preventDefault();

          stopInputCountdown();
          __statusBase = 'Executing';
          startStatusDots(__statusBase);

          window.PolyShell?.stopInputTicker?.();
          window.PolyShell?.setRunnerPhase?.('running');

          const line = el.textContent;

          const pre    = document.getElementById('jconsole');
          const prefix = document.getElementById('consolePrefix');

          if (prefix && prefix.textContent) {
            pre.textContent += prefix.textContent;
            prefix.textContent = '';
          }

          termWrite(line + '\n');
          el.textContent = '';

          try {
            if (window.termWS && window.termWS.readyState === 1 && window.wsRunInFlight) {
              window.termWS.send(JSON.stringify({ type: 'stdin', data: line + '\n' }));
            }
          } catch {}

          focusConsoleInput?.();
        }
      }, { capture: true });

      let inputWaitMs = 5 * 60 * 1000; // 5 minutes
      let needsStdin = false;

      // ---- MAIN: Run (interactive first; fallback to Piston) ----
      window.runLang = async function (codeOverride) {
        clearEditorMarkers();
        const prefix = document.getElementById('consolePrefix');
        if (prefix) prefix.textContent = '';
        showInputRow(false);

        // disable Complexity at the start of every run
        setComplexityEnabled(false);

        const raw = (typeof codeOverride === 'string' && codeOverride.trim())
          ? codeOverride
          : (window.editor ? window.editor.getValue() : '');

        const { code, stdin } = extractInlineStdin(raw);
        const className = detectClassToRun(code);
        const fileName  = `${className}.java`;

        setConsole('');

        (function(){
  const s = document.getElementById('stderrText');
  if (s) s.textContent = '';
  const x = document.getElementById('stderrExplain');
  if (x) x.innerHTML = '';
  const b = document.getElementById('pcFailNote');
  if (b) b.remove();
})();

        
        document.getElementById('output')?.classList.remove('error');

        needsStdin = codeNeedsInput(code);

        let ws = (window.termWS && window.termWS.readyState === 1) ? window.termWS : null;

        if (!ws) {
          ws = await ensureRunnerWS(10000, { showOverlay: true });
        }
        if (!ws) {
          try { await fetch('https://polycode-java.onrender.com/health', { cache:'no-store', mode:'no-cors' }); } catch {}
          ws = await ensureRunnerWS(60000, { showOverlay: true });
        }
        if (!ws) {
          hideRunnerOverlay();
          window.PolyShell?.setStatus('Runner unavailable — please retry', 'error');
          window.setRunUI?.(false);
          throw new Error('runner_unavailable');
        }

        window.termWS = ws;

        if (ws) {
          window.wsRunInFlight = true;
          __statusBase = needsStdin ? 'Running (interactive)' : 'Running';
          startStatusDots(__statusBase);
          showInputRow(false);
          window.PolyShell?.setStatus(
            needsStdin ? 'Running (interactive – waiting for input)…' : 'Running (interactive)…',
            'busy'
          );

          const acc = { compileErr: '', stderr: '', stdout: '' };

          const waitForExit = new Promise((resolve, reject) => {
            const onMsg = async(ev) => {
              try {
                const m = JSON.parse(String(ev.data));
                if (m.type === 'pong') return;

                if (m.type === 'stdout') {
                  acc.stdout += m.data;
                  termWrite(m.data);
                  if (typeof window.maybeShowInputWaitFromStdout === 'function') {
                    window.maybeShowInputWaitFromStdout(m.data);
                  }
                } else if (m.type === 'stdin_req') {
                  showInputRow(true);
                  window.PolyShell?.setRunnerPhase?.('waiting_input', { detail: getCountdownText?.() });
                  window.PolyShell?.setStatus('Waiting for User Input...', 'busy');
                  __statusBase = 'Waiting for User Input';
                  startStatusDots(__statusBase);
                  startInputCountdown(inputWaitMs);
                  window.PolyShell?.startInputTicker?.(getCountdownText, 500);
                } else if (m.type === 'stderr') {
                  acc.stderr += m.data;
                  termWrite(m.data);
                  window.PolyShell?.stopInputTicker?.();
                  window.PolyShell?.setRunnerPhase?.('error');
                  stopInputCountdown();
                } else if (m.type === 'compileErr') {
                  acc.compileErr += m.data;
                  //termWrite(m.data);
                  const st = document.getElementById('stderrText');
  if (st) st.textContent = acc.compileErr.trim();
  showCompileFailNotice('compile');
  try { await refreshStderrExplanation(); } catch {}

                  
                  window.PolyShell?.stopInputTicker?.();
                  window.PolyShell?.setRunnerPhase?.('error');
                  stopInputCountdown();
                } else if (m.type === 'exit') {
                  window.PolyShell?.stopInputTicker?.();
                  stopInputCountdown();
                  stopStatusDots();

                  window.termWS.removeEventListener('message', onMsg);
                  window.wsRunInFlight = false;
                  showInputRow(false);

                  if (m.code === 0) {
                    window.PolyShell?.setRunnerPhase?.('success');
                    window.PolyShell?.setStatus('Execution Success', 'ok');
                    clearEditorMarkers();
                    setComplexityEnabled(true); // <— enable on success
                    resolve();
                  } else {
                    const errText   = (acc.compileErr || acc.stderr || 'Execution failed').trim();
                    const firstLine = (errText.split('\n')[0] || 'Execution failed');
                    const line      = findJavaErrorLine(errText, className);

                    // NEW: mirror to compiler area + banner + friendly
const st = document.getElementById('stderrText');
if (st) st.textContent = errText;
showCompileFailNotice('compile');
try { await refreshStderrExplanation(); } catch {}

                    
                    setEditorMarker(line, firstLine);
                    window.PolyShell?.setStatus('Execution Failed', 'error');
                    setComplexityEnabled(false); // ensure disabled on failure
                    reject(new Error(`line ${line}: ${firstLine}`));
                  }

                  window.setRunUI?.(false);
                }
              } catch {}
            };

            const onClose = () => {
              try { window.termWS?.removeEventListener('message', onMsg); } catch {}

              const userClose = !!window.__closingByUser;
              window.__closingByUser = false;

              try { stopHeartbeat?.(); } catch {}
              try { stopStatusDots?.(); } catch {}
              try { window.setRunUI?.(false); } catch {}
              stopInputCountdown();
              window.PolyShell?.stopInputTicker?.();

              if (userClose) {
                window.wsRunInFlight = false;
                showInputRow(false);
                window.termWS = null;
                return;
              }

              window.PolyShell?.setRunnerPhase?.('error', { detail: 'Runner disconnected' });
              if (window.wsRunInFlight) {
                window.wsRunInFlight = false;
                showInputRow(false);
                window.PolyShell?.setStatus('Runner disconnected — click Run to reconnect','error');
                try { reject(new Error('line 1: runner disconnected')); } catch {}
              }
              window.termWS = null;
            };

            window.termWS.addEventListener('message', onMsg);
            window.termWS.addEventListener('close', onClose, { once: true });
          });

          try {
            const argsStr = document.getElementById('progArgs')?.value || '';
            const args = argsStr.trim() ? argsStr.match(/\S+/g) : [];

            inputWaitMs = 5 * 60 * 1000;
            window.termWS.send(JSON.stringify({
              type: 'run',
              className,
              code: raw + '',
              args,
              inputWaitMs
            }));
          } catch {
            try { window.termWS.close(); } catch {}
            showInputRow(false);
            window.PolyShell?.setStatus('Runner unavailable', 'error');
            setComplexityEnabled(false);
            throw new Error('line 1: runner unavailable');
          }

          await waitForExit;
          return;
        }

        // ---- Fallback: Piston ----
        let version = await getPistonJavaVersion();
        let res     = await pistonExecuteJava({ code, fileName, version, stdin });

        if (!res.ok && /version.*(required|unknown)/i.test(res.text || '')) {
          version = await getPistonJavaVersion(true);
          res     = await pistonExecuteJava({ code, fileName, version, stdin });
        }
        if (!res.ok) {
          printToConsole({ compileErr: `HTTP ${res.status} — ${res.text.slice(0, 200)}` });
          setComplexityEnabled(false);
          throw new Error('line 1: request failed');
        }

        const data       = res.data || {};
        const compileErr = data.compile?.stderr || '';
        const stderr     = data.run?.stderr || '';
        const stdout     = data.run?.stdout || '';


        // Mirror compiler/runtime text
const st = document.getElementById('stderrText');
if (st) st.textContent = (compileErr || stderr || '').trim();

// If failure, show banner + friendly
const prelimOk = (data.run?.code === 0) && !compileErr;
if (!prelimOk) {
  showCompileFailNotice('compile');
  Promise.resolve().then(() => refreshStderrExplanation()).catch(() => {});
}


        
        const usedScanner = /\bnew\s+Scanner\s*\(\s*System\.in\s*\)/.test(code);
        if (usedScanner && !stdin && data.run?.code !== 0 && /NoSuchElementException/.test(stderr || '')) {
          const tip =
            '\nTip: Provide input using a comment:\n' +
            '  // stdin: 2 3\n' +
            '  /* stdin:\n2\n3\n*/\n';
          printToConsole({ compileErr: (stderr || compileErr || 'Runtime error') + tip });
        }

        printToConsole({ compileErr, stderr, stdout, exitCode: data.run?.code });

        const ok = (data.run?.code === 0) && !compileErr;
        if (ok) {
          window.PolyShell?.stopInputTicker?.();
          window.PolyShell?.setRunnerPhase?.('success');
          window.PolyShell?.setStatus('Execution Success', 'ok');
          clearEditorMarkers();
          setComplexityEnabled(true);  // <— enable on success (Piston)
        } else {
          const errText   = (compileErr || stderr || 'Execution failed').trim();
          const firstLine = (errText.split('\n')[0] || 'Execution failed');
          const line      = findJavaErrorLine(errText, className);
          setEditorMarker(line, firstLine);
          window.PolyShell?.setStatus('Execution Failed', 'error');
          setComplexityEnabled(false);
          throw new Error(`line ${line}: ${firstLine}`);
        }
      };

      // ---- Reset (called by shell) ----
      window.clearLang = function () {
        window.__closingByUser = true;

        setConsole('');
        document.getElementById('output')
          ?.style.setProperty('background', 'transparent', 'important');

        (function(){ try{
          const prefix = document.getElementById('consolePrefix');
          if (prefix) prefix.textContent = '';
        }catch{} })();

        (function(){ try{
          const row = document.getElementById('consoleRow');
          if (row) row.style.display = 'none';
        }catch{} })();
        (function(){ try{
          if (window.monaco && window.editor) {
            const model = window.editor.getModel();
            model && monaco.editor.setModelMarkers(model, 'javac', []);
          }
        }catch{} })();

        try { window.termWS?.close(); } catch {}
        window.termWS = null;
        window.wsRunInFlight = false;

        // disable Complexity on reset
        setComplexityEnabled(false);
      };

    })();

    // ---------- Runner connect overlay helpers ----------
    function showRunnerOverlay(msg = 'Connecting to Java runner…', pct = 10, hint = 'Warming up backend…') {
      const ov  = document.getElementById('runnerOverlay');
      const bar = document.getElementById('runnerBar');
      const m   = document.getElementById('runnerMsg');
      const h   = document.getElementById('runnerHint');
      if (!ov || !bar || !m || !h) return;
      ov.style.display = 'flex';
      m.textContent = msg;
      h.textContent = hint;
      bar.style.width = Math.max(5, Math.min(100, Math.floor(pct))) + '%';
    }

    function updateRunnerOverlay({ msg, pct, hint }) {
      const m   = document.getElementById('runnerMsg');
      const h   = document.getElementById('runnerHint');
      const bar = document.getElementById('runnerBar');
      if (msg && m) m.textContent = msg;
      if (hint && h) h.textContent = hint;
      if (typeof pct === 'number' && bar) {
        bar.style.width = Math.max(5, Math.min(100, Math.floor(pct))) + '%';
      }
    }

    function hideRunnerOverlay() {
      const ov = document.getElementById('runnerOverlay');
      if (ov) ov.style.display = 'none';
    }

    // ---------- Heartbeat ----------
    let hbInterval = null, hbTimeout = null;
    function startHeartbeat(ws) {
      stopHeartbeat();
      hbInterval = setInterval(() => {
        try {
          if (ws.readyState !== 1) return;
          ws.send(JSON.stringify({ type: 'ping' }));
          clearTimeout(hbTimeout);
          hbTimeout = setTimeout(() => {
            console.warn('Runner heartbeat missed; connection may drop.');
          }, 5000);
        } catch {}
      }, 25000);
    }
    function stopHeartbeat() {
      if (hbInterval) { clearInterval(hbInterval); hbInterval = null; }
      if (hbTimeout)  { clearTimeout(hbTimeout);   hbTimeout  = null; }
    }

    // ---------- Robust connect with wake + retries ----------
    async function ensureRunnerWS(maxTotalMs = 20000, { showOverlay = false } = {}) {
      if (showOverlay) showRunnerOverlay('Connecting to Java runner…', 8, 'Opening WebSocket…');

      if (!navigator.onLine) {
        if (showOverlay) updateRunnerOverlay({ pct: 100, hint: 'You appear to be offline.' });
        return null;
      }
      const start = Date.now();
      const steps = [400, 900, 1500, 2500, 4000, 6000, 8000];
      let attempt = 0;

      if (showOverlay) {
        showRunnerOverlay('Connecting to Java runner…', 8, 'Opening WebSocket…');
      }

      while (Date.now() - start < maxTotalMs) {
        attempt++;
        const perTimeout = Math.min(7000, maxTotalMs - (Date.now() - start));

        const ws = await new Promise((resolve) => {
          let done = false, timer, w;
          const finish = (val) => { if (!done) { done = true; clearTimeout(timer); resolve(val); } };
          timer = setTimeout(() => { try { w?.close(); } catch {} finish(null); }, perTimeout);
          try {
            w = new WebSocket('wss://polycode-java.onrender.com/java');
            w.onopen  = () => finish(w);
            w.onerror = () => {/* close will fire */};
            w.onclose = () => finish(null);
          } catch { finish(null); }
        });

        if (ws && ws.readyState === 1) {
          if (showOverlay) { updateRunnerOverlay({ pct: 95, hint: 'Finalizing…' }); hideRunnerOverlay(); }
          startHeartbeat(ws);
          return ws;
        }

        const wait = steps[Math.min(attempt - 1, steps.length - 1)];
        if (showOverlay) {
          const pct = Math.min(92, 18 + Math.floor((attempt / (steps.length + 3)) * 70));
          updateRunnerOverlay({ pct, hint: `Retry ${attempt}…` });
        }
        await new Promise(r => setTimeout(r, wait));
      }

      if (showOverlay) updateRunnerOverlay({ pct: 100, hint: 'Runner unavailable.' });
      return null;
    }

    /* --- Start after shell.js (defer) has run --- */
    (function startWhenReady() {
      function start() {
        if (!window.PolyShell) {
          const id = setInterval(() => {
            if (window.PolyShell) { clearInterval(id); window.bootstrap(); }
          }, 25);
          setTimeout(() => clearInterval(id), 3000);
          return;
        }
        window.bootstrap();
      }
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', start, { once: true });
      } else {
        start();
      }
    })();

    // Gentle wake when user returns, without showing overlay
    let __wakeTimer = 0;
    function requestWakeSoon() {
      clearTimeout(__wakeTimer);
      __wakeTimer = setTimeout(async () => {
        if (!window.termWS || window.termWS.readyState !== 1) {
          try { await fetch('https://polycode-java.onrender.com/health', { cache:'no-store', mode:'no-cors' }); } catch {}
        }
      }, 300);
    }
    document.addEventListener('visibilitychange', () => { if (!document.hidden) requestWakeSoon(); });
    window.addEventListener('focus', requestWakeSoon);
    window.addEventListener('pageshow', (e) => { if (e.persisted) requestWakeSoon(); });
  </script>

  <!-- Connecting overlay -->
  <div
    id="runnerOverlay"
    style="position: fixed; inset: 0; display: none; align-items: center; justify-content: center; background: rgba(0,0,0,0.45); z-index: 9999;"
  >
    <div
      style="min-width: 280px; max-width: 420px; padding: 16px 18px; border-radius: 12px; background: var(--panel, #111); color: inherit; box-shadow: 0 6px 24px rgba(0,0,0,0.35); font: 14px/1.4 ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto;"
    >
      <div id="runnerMsg" style="font-weight:600; margin-bottom:8px;">Connecting to Java runner…</div>
      <div style="height:8px; background: rgba(255,255,255,0.15); border-radius: 999px; overflow:hidden;">
        <div id="runnerBar" style="height:100%; width:10%; background: currentColor; opacity:0.9;"></div>
      </div>
      <div id="runnerHint" style="margin-top:8px; opacity:0.8;">Warming up backend…</div>
    </div>
  </div>



<script src="./js/complexity.js" defer></script>
<script src="./js/lang-select.js" defer></script>






<script type="module">
  import { parseCompilerOutput, renderHintHTML } from './js/error-helper.js';
  // Expose for shell.js if needed:
  window.PolyErrorHelper = { parseCompilerOutput, renderHintHTML };
</script>

  
</body>
</html>
