<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
 

  <title>polycode | SQL</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, interactive-widget=resizes-content" />

  <link rel="icon" href="./assets/logo.png" />
  <link rel="stylesheet" href="./css/shell.css" />
  <link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>
  <meta name="color-scheme" content="dark light">
</head>

<body class="page-fade">
  <!-- Header -->
<header class="site-header">
  <!-- centered brand block -->
  <div class="brand-wrap">
    <div class="brand-grid">
      <img src="./assets/PC-Logo.png" alt="polycode" class="brand-logo" />
      <div class="brand-title2">polycode</div>
      <div class="brand-tagline2">
        learn<span class="dot">.</span>code<span class="dot">.</span>execute
      </div>
    </div>
  </div>

  <!-- right nav -->
  <nav class="site-nav">
    <a href="./index.html">Home</a>
    <a href="./about.html">About</a>
    <a href="./contact.html">Contact</a>
  </nav>
</header>


<!-- place anywhere in <body>, e.g., just after <header> -->
<div id="status" role="status" aria-live="polite"
     style="position:absolute;left:-9999px;width:1px;height:1px;overflow:hidden;"></div>



  <!-- App -->
   <main class="stage" role="main">

    <div class="app">
      <!-- LEFT panel -->
      <section class="panel left" id="leftPanel">
        <div class="pane-head">
          <!-- Language dropdown in the top bar (full width) -->
          <select id="langSelect" class="select" aria-label="Choose language" onchange="location.href=this.value" disabled>
            <option value="./index-sql.html" selected>SQL (MySQL/SQLite)</option>
            <option value="./index-c.html">C</option>
            <option value="./index-cpp.html">C++</option>
            <option value="./index-web.html">HTML/CSS/JS</option>
            <option value="./index-java.html">Java</option>
            <option value="./index-python.html">Python</option>
            <option value="scratch">Scratch</option>

          </select>
          <div class="right-controls">
      <!-- existing left controls… -->
      <button class="btn expander" onclick="toggleExpand('left', this)" aria-pressed="false" title="Expand Left panel">⤢</button>
    </div>

        </div>
        <div class="pane-scroll">
        <div class="pane-body">
          <!-- Editable content pulled from /content/sql.html -->
         

          <div id="leftContent" style="margin-top:12px;"></div>
        </div>
         <div class="pane-foot"><span class="msg" id="leftFoot">About SQL</span></div>
        </div>
      </section>

   

      <!-- CENTER panel (Editor) -->
      <section class="panel center" id="centerPanel">
        <div class="pane-head">
  <!-- theme first (6) -->

           <button id="btnToggleLeft"  class="btn btn-toggle" aria-pressed="false"  title="Show/Hide Left Panel">
  <!-- sidebar-left icon -->
  <svg viewBox="0 0 24 24" width="18" height="18" aria-hidden="true">
    <rect x="3" y="4" width="6" height="16" rx="1" />
    <rect x="10" y="4" width="11" height="16" rx="1" fill="none" stroke="currentColor" stroke-width="2"/>
  </svg>
</button>

          
  <button id="themeToggle" class="btn theme-btn" title="Toggle theme" aria-label="Toggle theme">
    <svg viewBox="0 0 24 24" id="themeIcon"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg>
  </button>

 
<button id="btnToggleRight" class="btn btn-toggle" aria-pressed="true"  title="Show/Hide Output Panel" hidden>
  <!-- terminal/output icon -->
  <svg viewBox="0 0 24 24" width="18" height="18" aria-hidden="true">
    <rect x="3" y="4" width="18" height="16" rx="2" fill="none" stroke="currentColor" stroke-width="2"/>
    <path d="M7 9l3 3-3 3M12 15h5" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"/>
  </svg>
</button>

  <div class="right-controls" style="margin-left:auto; display:flex; gap:8px; align-items:center;">

   <button id="btnSaveFile" class="btn" title="Capture & Share (Ctrl/Cmd+S)" aria-label="Capture & Share">
  <svg viewBox="0 0 24 24" width="18" height="18" aria-hidden="true">
    <!-- camera frame -->
    <rect x="3" y="6" width="18" height="13" rx="2" ry="2"
          fill="none" stroke="currentColor" stroke-width="2"/>
    <!-- top bar / notch -->
    <path d="M9 6l1.5-2h3L15 6" fill="none" stroke="currentColor" stroke-width="2"/>
    <!-- focus dot -->
    <circle cx="12" cy="12" r="2.5" fill="currentColor"/>
  </svg>
</button>



<!-- Share (builds a PDF then shares) -->
<button id="btnSharePdf" class="btn" title="Download PDF" aria-label="Download PDF">
              <svg viewBox="0 0 24 24"><path d="M5 20h14v-2H5v2zM7 9h4V3h2v6h4l-5 5-5-5z" fill="currentColor"/></svg>
            </button>



    
    <!-- Run -->
    <button id="btnRun" class="btn primary attn" title="Execute (Click or Press F9)" aria-label="Run">
      <svg viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg>
    </button>
  </div>
</div>
<div class="pane-scroll">
        <div id="editor"></div>
        <div class="pane-foot"><span class="msg" id="centerFoot">Ready for Execution</span></div>
</div>
      </section>

    

      <!-- RIGHT panel (Screen) -->
      <section class="panel right" id="rightPanel">
        <div class="pane-head">
       
          <div class="right-controls" style="margin-left:auto; display:flex; gap:8px;">
            <button class="btn expander" onclick="toggleExpand('right', this)" aria-pressed="false" title="Expand Output">⤢</button>

            <!-- Reset -->
            <button id="btnReset" class="btn" title="Reset (Click or Press F10)" aria-label="Reset">
              <svg viewBox="0 0 24 24"><path d="M12 6v3l4-4-4-4v3C7.58 4 4 7.58 4 12s3.58 8 8 8a8 8 0 007.39-4.91l-1.85-.77A6 6 0 1112 6z"/></svg>
            </button>
          </div>
        </div>

        <div class="pane-scroll">
        <div id="output" class="screen-dim">
          <div id="sqlout"></div>

           <pre id="stderrText" class="console-block error" aria-label="Compiler Errors"></pre>
            <!-- NEW: explanations will be injected here -->
            <div id="stderrExplain" class="console-explain" aria-live="polite"></div>

          
        </div>
        <div class="pane-foot"><span class="msg" id="rightFoot">Waiting for Execution</span></div>
        </div>
      </section>
    </div>
  </main>



  <!-- Footer -->
<footer class="site-footer">
  <div class="footer-grid">
    <!-- Left: Edifica logo + powered + slogan -->
    <div class="footer-left">
      <img src="./assets/logo.png" alt="Edifica" class="footer-logo" />
      <div class="txt">
        <span class="powered">powered by edifica</span>
       <span class="subline">
  education<span class="dot">.</span>consultation<span class="dot">.</span>assistance
</span>
<div class="siteurl">
  <a href="https://www.edifica.in" target="_blank" rel="noopener">www.edifica.in</a>
</div>

       
      </div>
    </div>

    <!-- Center: Follow us + icons (auto colors by theme) -->
    <div class="footer-center">
      <span class="label">Follow us</span>
      <a class="social" href="https://facebook.com/edifica.facebook" target="_blank" rel="noopener" aria-label="Facebook" title="Facebook">
        <!-- FB -->
        <svg viewBox="0 0 24 24" width="18" height="18"><path d="M22 12.07C22 6.48 17.52 2 11.93 2S2 6.48 2 12.07c0 5.01 3.66 9.16 8.44 9.93v-7.03H7.9v-2.9h2.54V9.41c0-2.5 1.49-3.89 3.77-3.89 1.09 0 2.24.2 2.24.2v2.47h-1.26c-1.24 0-1.63.77-1.63 1.56v1.88h2.78l-.44 2.9h-2.34v7.03C18.34 21.23 22 17.08 22 12.07z"/></svg>
      </a>
      <a class="social" href="https://instagram.com/edifica.ig" target="_blank" rel="noopener" aria-label="Instagram" title="Instagram">
        <!-- IG -->
        <svg viewBox="0 0 24 24" width="18" height="18"><path d="M7 2h10a5 5 0 0 1 5 5v10a5 5 0 0 1-5 5H7a5 5 0 0 1-5-5V7a5 5 0 0 1 5-5zm5 5a5 5 0 1 0 0 10 5 5 0 0 0 0-10zm6.5-.5a1.5 1.5 0 1 0 0 3 1.5 1.5 0 0 0 0-3zM12 9.5A2.5 2.5 0 1 1 9.5 12 2.5 2.5 0 0 1 12 9.5z"/></svg>
      </a>
      <a class="social" href="https://youtube.com/@edifica.youtube" target="_blank" rel="noopener" aria-label="YouTube" title="YouTube">
        <!-- YT -->
        <svg viewBox="0 0 24 24" width="18" height="18"><path d="M23.5 6.2a3 3 0 0 0-2.1-2.1C19.4 3.5 12 3.5 12 3.5s-7.4 0-9.4.6A3 3 0 0 0 .5 6.2 31.7 31.7 0 0 0 0 12a31.7 31.7 0 0 0 .6 5.8 3 3 0 0 0 2.1 2.1c2 .6 9.3.6 9.3.6s7.4 0 9.4-.6a3 3 0 0 0 2.1-2.1c.4-1.9.6-3.9.6-5.8 0-1.9-.2-3.9-.6-5.8zM9.6 15.5V8.5L16 12l-6.4 3.5z"/></svg>
      </a>
    </div>

    <!-- Right: legal links (now underlined) -->
    <div class="footer-right">
      <a href="./privacy.html">Privacy Policy</a>
      <a href="./terms.html">Terms &amp; Conditions</a>
      <a href="./legal.html">Legal Information</a>
    </div>
  </div>
</footer>

  
<script>window.__oldDefine = window.define; window.define = undefined;</script>
<script defer src="https://cdn.jsdelivr.net/npm/sql.js@1.10.2/dist/sql-wasm.js"></script>
<script defer src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
<script defer src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
<script>window.define = window.__oldDefine; delete window.__oldDefine;</script>

<!-- Now load Monaco’s AMD loader ONCE -->
<script defer src="https://cdn.jsdelivr.net/npm/monaco-editor@0.45.0/min/vs/loader.min.js"></script>


  <script defer src="./js/shell.js"></script>

  <!-- Page script -->


  <script defer>
  const SAMPLE_SQL =
`-- In-browser SQL (sql.js)
CREATE TABLE users(id INTEGER, name TEXT);
INSERT INTO users VALUES (1,'Alice'),(2,'Bob');
SELECT * FROM users;`;

  let db;


    // --- Monaco marker for SQL (optional but nice)
function setSqlEditorMarker(line, message){
  const m = window.monaco, ed = window.editor;
  if (!m || !ed) return;
  const model = ed.getModel(); if (!model) return;
  const ln = Math.max(1, Number(line) || 1);
  const maxCol = Math.max(1, model.getLineMaxColumn(ln));
  m.editor.setModelMarkers(model, 'sql-err', [{
    startLineNumber: ln, endLineNumber: ln,
    startColumn: 1, endColumn: maxCol,
    message: String(message || 'SQL error'),
    severity: m.MarkerSeverity.Error
  }]);
}
function clearSqlEditorMarkers(){
  const m = window.monaco, ed = window.editor;
  if (!m || !ed) return;
  const model = ed.getModel(); if (!model) return;
  m.editor.setModelMarkers(model, 'sql-err', []);
}

// Try to guess a line number from common sql.js messages
function guessSqlErrorLine(msg){
  const s = String(msg || '');
  let m = /near\s+line\s+(\d+)/i.exec(s);      if (m) return +m[1];
  m = /\bline\s+(\d+)\b/i.exec(s);             if (m) return +m[1];
  // Some builds say "at offset N" — convert offset to line
  m = /offset\s+(\d+)/i.exec(s);
  if (m && window.editor){
    const off = +m[1] || 0;
    const text = window.editor.getValue() + '';
    let cur = 0, line = 1;
    for (let i=0; i<text.length && i<off; i++){
      if (text.charCodeAt(i) === 10) line++;
    }
    return line;
  }
  return 1;
}



function mysqlDescribeToSqlite(sql) {
  const noBlock = sql.replace(/\/\*[\s\S]*?\*\//g, '');
  const noLine  = noBlock.replace(/--[^\n]*$/gm, '');

  const parts = [];
  let buf = '', inS = false, inD = false;
  for (let i = 0; i < noLine.length; i++) {
    const ch = noLine[i];
    if (ch === "'" && !inD) inS = !inS;
    if (ch === '"' && !inS) inD = !inD;
    if (ch === ';' && !inS && !inD) { if (buf.trim()) parts.push(buf.trim()); buf = ''; }
    else buf += ch;
  }
  if (buf.trim()) parts.push(buf.trim());

  const rewritten = parts.map((stmt) => {
    const m = stmt.match(
      /^(?:DESC|DESCRIBE)\s+((?:[A-Za-z_][A-Za-z0-9_]*\.)?(?:`?[A-Za-z_][A-Za-z0-9_]*`?|"(?:[^"]+)"))\s*$/i
    );
    if (!m) return stmt;

    let raw = m[1].trim();
    if (raw.includes('.')) raw = raw.split('.', 2)[1];
    raw = raw.replace(/^`|`$/g, '');
    if (/^".*"$/.test(raw)) raw = raw.slice(1, -1);
    const tbl = raw.replace(/'/g, "''");

    return `
WITH cols AS (
  SELECT cid, name, type, [notnull] AS nn, dflt_value, pk
  FROM pragma_table_info('${tbl}')
),
u AS (
  /* per-column uniqueness from all indexes */
  SELECT ii.name AS col, MAX(il.[unique]) AS is_unique
  FROM pragma_index_list('${tbl}') AS il
  JOIN pragma_index_info(il.name) AS ii
  GROUP BY ii.name
)
SELECT
  cols.name                           AS "Field",
  cols.type                           AS "Type",
  CASE cols.nn WHEN 0 THEN 'YES' ELSE 'NO' END AS "Null",
  CASE
    WHEN cols.pk = 1 THEN 'PRI'
    WHEN COALESCE(u.is_unique, 0) = 1 THEN 'UNI'
    ELSE ''
  END                                 AS "Key",
  cols.dflt_value                     AS "Default",
  ''                                  AS "Extra"
FROM cols
LEFT JOIN u ON u.col = cols.name
ORDER BY cols.cid
`.trim();
  });

  return rewritten.join(';\n') + (rewritten.length ? ';' : '');
}





    
  async function bootstrap(){
    await PolyShell.initMonaco({ value: SAMPLE_SQL, language: 'sql' });
    const SQL = await window.initSqlJs({
      locateFile: f => 'https://cdn.jsdelivr.net/npm/sql.js@1.10.2/dist/' + f
    });
    db = new SQL.Database();
    PolyShell.setStatus('Ready','ok');
    PolyShell.loadLeftContent('sql');
  }

  // Robust start: wait until shell.js has created window.PolyShell
  (function startWhenReady(){
    if (window.PolyShell) return void bootstrap();
    const id = setInterval(() => {
      if (window.PolyShell){ clearInterval(id); bootstrap(); }
    }, 25);
    setTimeout(() => clearInterval(id), 5000);
  })();

  window.runLang = async function (codeOverride) {
    if (!db) await bootstrap();
    const out = document.getElementById('sqlout');
    out.innerHTML = '';

    (function(){
  const s = document.getElementById('stderrText');     if (s) s.textContent = '';
  const x = document.getElementById('stderrExplain');  if (x) x.innerHTML = '';
  const b = document.getElementById('pcFailNote');     if (b) b.remove();
  clearSqlEditorMarkers();
})();




    
    try {
      let sql = (typeof codeOverride === 'string' && codeOverride.trim())
        ? codeOverride
        : window.editor.getValue();

sql = mysqlDescribeToSqlite(sql);

/* helpers scoped to runLang */
const splitSqlSafe = (src) => {
  const outArr = []; let b = '', s = false, d = false;
  for (let i = 0; i < src.length; i++) {
    const ch = src[i];
    if (ch === "'" && !d) s = !s;
    if (ch === '"' && !s) d = !d;
    if (ch === ';' && !s && !d) { if (b.trim()) outArr.push(b.trim()); b = ''; }
    else b += ch;
  }
  if (b.trim()) outArr.push(b.trim());
  return outArr;
};
const kindOf = (stmt) => {
  const m = /^\s*([A-Za-z]+)/.exec(stmt);
  return m ? m[1].toUpperCase() : '';
};
const renderInfo = (msg) => {
  const block = document.createElement('div');
  block.className = 'console-block';
  block.style.cssText = 'border:1px solid var(--border);padding:8px 10px;margin:10px 0;background:var(--panel)';
  block.textContent = msg;
  out.appendChild(block);
};

/* run statement-by-statement so we can show status messages */
const stmts = splitSqlSafe(sql);
let resNum = 0;
let anyRendered = false;

for (const stmt of stmts) {
  const rs = db.exec(stmt);

  if (rs.length) {
    anyRendered = true;
    rs.forEach((r) => {
      const block = document.createElement('div');

      const title = document.createElement('div');
      title.textContent = `Result ${++resNum} — ${r.values.length} row${r.values.length === 1 ? '' : 's'}`;
      title.style.cssText = 'font-size:12.5px;color:var(--muted);margin:8px 0 6px;';
      block.appendChild(title);

      const wrap = document.createElement('div');
      wrap.style.cssText = 'max-width:100%;overflow:auto;border:1px solid var(--border);';

      const table = document.createElement('table');
      table.style.borderCollapse = 'collapse';
      table.style.width = '100%';

      const thead = document.createElement('thead');
      const trh = document.createElement('tr');
      r.columns.forEach(c => {
        const th = document.createElement('th');
        th.textContent = c;
        th.style.cssText = 'border:1px solid var(--border);padding:6px 8px;background:var(--panel-2);position:sticky;top:0;';
        trh.appendChild(th);
      });
      thead.appendChild(trh);
      table.appendChild(thead);

      const tbody = document.createElement('tbody');
      r.values.forEach(row => {
        const tr = document.createElement('tr');
        row.forEach(cell => {
          const td = document.createElement('td');
          td.textContent = cell === null ? 'NULL' : String(cell);
          td.style.cssText = 'border:1px solid var(--border);padding:6px 8px;';
          tr.appendChild(td);
        });
        tbody.appendChild(tr);
      });
      table.appendChild(tbody);

      wrap.appendChild(table);
      block.appendChild(wrap);
      block.style.marginBottom = '14px';
      out.appendChild(block);
    });
  } else {
    // No result set => friendly status line
    const k = kindOf(stmt);
    const n = db.getRowsModified();
    let msg = '✓ Statement executed.';

    if (k === 'INSERT') msg = `✅ Inserted ${n} row${n === 1 ? '' : 's'}.`;
    else if (k === 'UPDATE') msg = `✅ Updated ${n} row${n === 1 ? '' : 's'}.`;
    else if (k === 'DELETE') msg = `✅ Deleted ${n} row${n === 1 ? '' : 's'}.`;
    else if (k === 'CREATE') msg = '✅ Table created successfully.';
    else if (k === 'DROP')   msg = '✅ Dropped successfully.';
    else if (k === 'ALTER')  msg = '✅ Schema altered successfully.';

    renderInfo(msg);
    anyRendered = true;

    // Optional: show last rowid after INSERT
    if (k === 'INSERT') {
      try {
        //const rid = db.exec(`SELECT last_insert_rowid() AS rowid`);
        //const id = rid?.[0]?.values?.[0]?.[0];
        //if (id != null) renderInfo(`ℹ️ last_insert_rowid() = ${id}`);
      } catch {}
    }
  }
}

if (!anyRendered) {
  out.textContent = '(no rows)';
}

   } catch (e) {
  const msg = (e?.message || String(e || 'SQL error')).trim();

  // Clear the results grid so we don't duplicate the message
  const out = document.getElementById('sqlout');
  if (out) out.replaceChildren(); // or: out.textContent = '';

  // 1) Mirror into the compiler/error block
  const st = document.getElementById('stderrText');
  if (st) st.textContent = msg;

  // 2) Red banner (reuse compile banner for SQL runtime errors)
  if (!document.getElementById('pcFailNote')) {
    showCompileFailNotice('runtime'); // shows "Runtime Error — See Details Below."
  }

  // 3) Friendly explanation
  try { await refreshStderrExplanation(); } catch {}

  // 4) Monaco marker (best guess)
  try {
    const line = guessSqlErrorLine(msg);
    const firstLine = msg.split('\n')[0] || 'SQL error';
    setSqlEditorMarker(line, firstLine);
  } catch {}

  // IMPORTANT: don't write msg into #sqlout anymore
  // throw so shell.js can set status/footers
  throw e;
}


  };

  /*window.clearLang = function(){
    document.getElementById('sqlout').innerHTML = '';
  };*/


window.clearLang = function () {
  // SQL page
  const sqlout = document.getElementById('sqlout');
  if (sqlout) sqlout.replaceChildren();

  try { const s = document.getElementById('stderrText');    if (s) s.textContent = ''; } catch{}
try { const x = document.getElementById('stderrExplain'); if (x) x.innerHTML = ''; } catch{}
try { const b = document.getElementById('pcFailNote');    if (b) b.remove(); } catch{}
try { clearSqlEditorMarkers(); } catch{}

  
  // Web page
  const frame = document.getElementById('preview');
  if (frame) {
    const mode = window.PolyShell?.getTheme?.() || (document.body.classList.contains('light') ? 'light' : 'dark');
    frame.srcdoc = `
      <!doctype html><meta charset="utf-8">
      <meta name="color-scheme" content="${mode}">
      <style>
        :root{ color-scheme:${mode}; }
        html,body{ margin:0; background:transparent !important; color:inherit; }
      </style>
      <body></body>
    `;
  }

  // Belt & suspenders
  document.getElementById('output')
    ?.style.setProperty('background','transparent','important');
};



    
</script>


  <script src="./js/lang-select.js" defer></script>
 
<script type="module">
  import { parseCompilerOutput, renderHintHTML } from './js/error-helper.js';
  // Expose for shell.js if needed:
  window.PolyErrorHelper = { parseCompilerOutput, renderHintHTML };
</script>

  
</body>
</html>
