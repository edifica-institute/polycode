<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>polycode | C</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="icon" href="./assets/logo.png" />
  <link rel="stylesheet" href="./css/shell.css" />
  <link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>
  <meta name="color-scheme" content="dark light" />
  <style>
    #consoleRow span{background:transparent!important;padding:0!important;border-radius:0!important}
    #consoleInput{display:inline-block;min-width:5ch;background:transparent;border:0;outline:0;box-shadow:none;caret-color:currentColor;user-select:text;-webkit-user-modify:read-write-plaintext-only}
    #consoleInput:focus{outline:0}
    #consoleInput::selection{background:rgba(255,255,255,.15)}
    .pane-foot .msg{white-space:nowrap}
    .panel .pane-head{display:flex;align-items:center}
  </style>

  <!-- point these at your Render service -->
  <script>
    window.RUNNER_WS = 'wss://polycode-java.onrender.com/term-c';
  </script>
</head>
<body class="page-fade">
  <header class="site-header">
    <div class="brand-wrap">
      <div class="brand-grid">
        <img src="./assets/PC-Logo.png" alt="polycode" class="brand-logo" />
        <div class="brand-title2">polycode</div>
        <div class="brand-tagline2">learn<span class="dot">.</span>code<span class="dot">.</span>execute</div>
      </div>
    </div>
    <nav class="site-nav">
      <a href="./index.html">Home</a>
      <a href="./about.html">About</a>
      <a href="./contact.html">Contact</a>
    </nav>
  </header>

  <div class="stage">
    <div class="app">
      <section class="panel left" id="leftPanel">
        <div class="pane-head">
          <select id="langSelect" class="select" onchange="location.href=this.value" aria-label="Choose language">
            <option value="./index-sql.html">SQL (MySQL/SQLite)</option>
            <option value="./index-web.html">HTML/CSS/JS</option>
            <option value="./index-java.html">Java</option>
            <option value="./index-c.html" selected>C</option>
          </select>
        </div>
        <div class="pane-body"><div id="leftContent" style="margin-top:12px;"></div></div>
        <div class="pane-foot"><span class="msg" id="leftFoot">About C</span></div>
      </section>

      <div class="v-resize"><div id="dragLeft"></div></div>

      <section class="panel center" id="centerPanel">
        <div class="pane-head">
          <button id="themeToggle" class="btn theme-btn" title="Toggle theme" aria-label="Toggle theme">
            <svg viewBox="0 0 24 24" id="themeIcon"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg>
          </button>
          <span class="title" id="centerTitle" style="margin-left:8px;">C – Editor | Polycode</span>
          <div style="margin-left:auto;display:flex;gap:8px;align-items:center;">
            <button id="btnSaveFile" class="btn" title="Save (Ctrl/Cmd + S)" aria-label="Save">
              <svg viewBox="0 0 24 24"><path d="M17 3H5a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V7l-4-4zm-5 16a3 3 0 1 1 0-6 3 3 0 0 1 0 6zm3-10H6V5h9v4z" fill="currentColor"/></svg>
            </button>
            <button id="btnRun" class="btn primary attn" title="Execute (F9)" aria-label="Run">
              <svg viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg>
            </button>
          </div>
        </div>
        <div id="editor"></div>
        <div class="pane-foot"><span class="msg" id="centerFoot">Ready for Execution</span></div>
      </section>

      <div class="v-resize right"><div id="dragRight"></div></div>

      <section class="panel right" id="rightPanel">
        <div class="pane-head">
          <span class="title">C – Console | Polycode</span>
          <div style="margin-left:auto;display:flex;align-items:center;">
            <button id="btnReset" class="btn" title="Reset (F10)" aria-label="Reset">
              <svg viewBox="0 0 24 24"><path d="M12 6v3l4-4-4-4v3C7.58 4 4 7.58 4 12s3.58 8 8 8a8 8 0 007.39-4.91l-1.85-.77A6 6 0 1112 6z"/></svg>
            </button>
          </div>
        </div>

        <div id="output" class="screen-dim" style="padding:12px;">
          <pre id="cconsole" class="console" style="margin:0;white-space:pre-wrap;"></pre>
          <div id="consoleRow" style="display:none;margin-top:0;gap:4px;align-items:baseline;font:14px/1.4 ui-monospace,Menlo,Consolas,monospace;">
            <span id="consolePrefix"></span>
            <span id="consoleInput" contenteditable="true" spellcheck="false"></span>
          </div>
        </div>

        <div class="pane-foot"><span class="msg" id="rightFoot">Waiting for Execution</span></div>
      </section>
    </div>
  </div>

  <footer class="site-footer">
    <div class="footer-grid">
      <div class="footer-left">
        <img src="./assets/logo.png" alt="Edifica" class="footer-logo" />
        <div class="txt">
          <span class="powered">powered by edifica</span>
          <span class="subline">education<span class="dot">.</span>consultation<span class="dot">.</span>assistance</span>
          <div class="siteurl"><a href="https://www.edifica.in" target="_blank" rel="noopener">www.edifica.in</a></div>
        </div>
      </div>
      <div class="footer-center">
        <span class="label">Follow us</span>
        <a class="social" href="https://facebook.com/edifica.facebook" target="_blank" aria-label="Facebook" title="Facebook">
          <svg viewBox="0 0 24 24" width="18" height="18"><path d="M22 12.07C22 6.48 17.52 2 11.93 2S2 6.48 2 12.07c0 5.01 3.66 9.16 8.44 9.93v-7.03H7.9v-2.9h2.54V9.41c0-2.5 1.49-3.89 3.77-3.89 1.09 0 2.24.2 2.24.2v2.47h-1.26c-1.24 0-1.63.77-1.63 1.56v1.88h2.78l-.44 2.9h-2.34v7.03C18.34 21.23 22 17.08 22 12.07z"/></svg>
        </a>
        <a class="social" href="https://instagram.com/edifica.ig" target="_blank" aria-label="Instagram" title="Instagram">
          <svg viewBox="0 0 24 24" width="18" height="18"><path d="M7 2h10a5 5 0 0 1 5 5v10a5 5 0 0 1-5 5H7a5 5 0 0 1-5-5V7a5 5 0 0 1 5-5zm5 5a5 5 0 1 0 0 10 5 5 0 0 0 0-10zm6.5-.5a1.5 1.5 0 1 0 0 3 1.5 1.5 0 0 0 0-3zM12 9.5A2.5 2.5 0 1 1 9.5 12 2.5 2.5 0 0 1 12 9.5z"/></svg>
        </a>
        <a class="social" href="https://youtube.com/@edifica.youtube" target="_blank" aria-label="YouTube" title="YouTube">
          <svg viewBox="0 0 24 24" width="18" height="18"><path d="M23.5 6.2a3 3 0 0 0-2.1-2.1C19.4 3.5 12 3.5 12 3.5s-7.4 0-9.4.6A3 3 0 0 0 .5 6.2 31.7 31.7 0 0 0 0 12a31.7 31.7 0 0 0 .6 5.8 3 3 0 0 0 2.1 2.1c.4-1.9.6-3.9.6-5.8zM9.6 15.5V8.5L16 12l-6.4 3.5z"/></svg>
        </a>
      </div>
      <div class="footer-right">
        <a href="./privacy.html">Privacy Policy</a>
        <a href="./terms.html">Terms &amp; Conditions</a>
        <a href="./legal.html">Legal Information</a>
      </div>
    </div>
  </footer>

  <script src="https://cdn.jsdelivr.net/npm/monaco-editor@0.45.0/min/vs/loader.min.js" defer></script>
  <script src="./js/shell.js" defer></script>



<script>
(() => {
  // ---------------- Runner endpoints ----------------
  const RUNNER_HTTP = window.RUNNER_HTTP || window.location.origin;
  const RUNNER_WS =
    window.RUNNER_WS ||
    ((location.protocol === 'https:' ? 'wss://' : 'ws://') + location.host + '/term-c');

  // ---------------- quick helpers ----------------
  const outEl     = () => document.getElementById('cconsole');
  const rowEl     = () => document.getElementById('consoleRow');
  const prefixEl  = () => document.getElementById('consolePrefix');
  const inputEl   = () => document.getElementById('consoleInput');

  function setConsole(t){ const el = outEl(); if(el){ el.textContent = t || ''; document.getElementById('output')?.scrollTo({top:1e9}); } }
  function termWrite(t){ const el = outEl(); if(el){ el.textContent += t; document.getElementById('output')?.scrollTo({top:1e9}); } }

  // Monaco markers (errors/warnings from gcc)
  function clearCMarkers(){
    if (!window.monaco || !window.editor) return;
    const model = window.editor.getModel();
    if (model) window.monaco.editor.setModelMarkers(model, 'gcc', []);
  }
  function setCMarkers(diags){
    if (!Array.isArray(diags) || !window.monaco || !window.editor) return;
    const model = window.editor.getModel(); if (!model) return;
    const markers = diags.map(d => ({
      startLineNumber: d.line || 1,
      endLineNumber:   d.line || 1,
      startColumn:     1,
      endColumn:       Math.max(1, model.getLineMaxColumn(d.line || 1)),
      message:         String(d.message || 'error'),
      severity:        /warn/i.test(d.severity) ? window.monaco.MarkerSeverity.Warning : window.monaco.MarkerSeverity.Error
    }));
    window.monaco.editor.setModelMarkers(model, 'gcc', markers);
  }

  // status dots
  let __timer = null, __base = '';
  function startDots(base){ stopDots(); __base = base || 'Running'; let dots=0; __timer=setInterval(()=>{ dots=(dots+1)%4; window.PolyShell?.setStatus(__base+'.'.repeat(dots),'busy'); },400); }
  function stopDots(){ if(__timer){ clearInterval(__timer); __timer=null; } }

  // input row
  function showInputRow(show){
    const row = rowEl(), pre = outEl(), pref = prefixEl();
    if (!row || !pre || !pref) return;
    row.style.display = show ? 'flex' : 'none';
    if (show){
      const txt = pre.textContent, i = txt.lastIndexOf('\n'), tail = txt.slice(i+1);
      if (tail && !/^\s*$/.test(tail)){ pref.textContent = tail + ' '; pre.textContent = txt.slice(0, i+1); }
      else pref.textContent = '';
    } else {
      if (pref.textContent){ pre.textContent += pref.textContent; pref.textContent=''; }
    }
  }
  function focusInput(){ const el = inputEl(); if(!el) return; el.focus(); const r=document.createRange(); r.selectNodeContents(el); r.collapse(false); const s=window.getSelection(); s.removeAllRanges(); s.addRange(r); }

  // Send stdin on Enter
  document.addEventListener('keydown', (e) => {
    const el = inputEl();
    if (!el || el.offsetParent === null) return;
    if (e.target !== el) return;
    if (e.key === 'Enter'){
      e.preventDefault();
      const line = el.textContent;
      const pre  = outEl();
      const pref = prefixEl();
      if (pref && pref.textContent){ pre.textContent += pref.textContent; pref.textContent = ''; }
      termWrite(line + '\n');
      el.textContent = '';
      try { if (window.termWS && window.termWS.readyState === 1 && window.wsRunInFlight){ window.termWS.send(JSON.stringify({ type:'stdin', data: line + '\n' })); } } catch {}
      focusInput();
    }
  }, { capture:true });

  // ----------- OPEN WS (with token) -----------
  async function openCWS(token, maxMs = 20000){
    const start = Date.now(), steps = [300,700,1200,2000,3200];
    let attempt = 0;
    while (Date.now() - start < maxMs){
      attempt++;
      const perTimeout = Math.min(7000, maxMs - (Date.now() - start));
      const ws = await new Promise((resolve) => {
        let done=false, timer, w;
        function finish(v){ if(!done){ done=true; clearTimeout(timer); resolve(v); } }
        try {
          const url = token ? (RUNNER_WS + '?token=' + encodeURIComponent(token)) : RUNNER_WS;
          w = new WebSocket(url);
        } catch { return resolve(null); }
        timer = setTimeout(() => { try{ w?.close(); }catch{} finish(null); }, perTimeout);
        w.onopen  = () => finish(w);
        w.onerror = () => {/* close follows */};
        w.onclose = () => finish(null);
      });
      if (ws && ws.readyState === 1) return ws;
      const wait = steps[Math.min(attempt - 1, steps.length - 1)];
      await new Promise(r => setTimeout(r, wait));
    }
    return null;
  }

  // ----------------- RUN (compile via HTTP → WS with token) -----------------
  window.runLang = async function runLang(){
    try { window.run = window.runLang; } catch {}
    // always start clean
    try { if (window.termWS) { window.termWS.onclose = null; window.termWS.close(); } } catch {}
    window.termWS = null; window.wsRunInFlight = false;

    clearCMarkers();
    setConsole('');
    window.PolyShell?.setStatus('Compiling…','busy');
    startDots('Compiling');

    const code = window.editor ? window.editor.getValue() : '';
    // 1) compile over HTTP
    let data;
    try{
      const files = [{ path: 'main.c', content: code }];
      const resp  = await fetch(RUNNER_HTTP + '/api/c/prepare', {
        method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ files })
      });
      data = await resp.json().catch(()=>({}));
      if (!resp.ok){ stopDots(); window.PolyShell?.setStatus('Compile request failed', 'error'); termWrite(String(data?.error||'HTTP error')+'\n'); return; }
    } catch (e){
      stopDots(); window.PolyShell?.setStatus('Compile request failed', 'error'); termWrite(String(e)+'\n'); return;
    }

    // show any diagnostics and gcc line
    if (Array.isArray(data?.diagnostics) && data.diagnostics.length) setCMarkers(data.diagnostics);
    if (data?.compileLog) termWrite(data.compileLog.replace(/\r/g,'') + (/\n$/.test(data.compileLog)?'':'\n'));

    if (!data?.ok || !data?.token){
      stopDots(); window.PolyShell?.setStatus('Compile failed', 'error');
      if (!data?.compileLog) termWrite('Compilation failed.\n');
      return;
    }

    // 2) open socket with token and stream the program
    window.PolyShell?.setStatus('Running…','busy');
    startDots('Running');

    const ws = await openCWS(data.token, 20000);
    if (!ws){
      stopDots(); window.PolyShell?.setStatus('Runner unavailable — please retry','error'); return;
    }
    window.termWS = ws;
    window.wsRunInFlight = true;

    const onMsg = (ev) => {
      try {
        const m = JSON.parse(String(ev.data));
        if (m.type === 'stdout')        termWrite(m.data);
        else if (m.type === 'stderr')   termWrite(m.data);
        else if (m.type === 'stdin_req'){ showInputRow(true); focusInput(); }
        else if (m.type === 'exit'){
          stopDots(); window.wsRunInFlight = false; showInputRow(false);
          window.PolyShell?.setStatus(m.code === 0 ? 'Execution Success' : 'Execution Failed', m.code === 0 ? 'ok' : 'error');
          try { ws.removeEventListener('message', onMsg); } catch {}
        }
      } catch {}
    };
    ws.addEventListener('message', onMsg);

    ws.addEventListener('close', (e) => {
      stopDots();
      if (window.wsRunInFlight){
        window.wsRunInFlight = false;
        const reason = (e && e.code) ? `WS closed ${e.code}${e.reason?(' ('+e.reason+')'):''}` : 'Runner disconnected';
        window.PolyShell?.setStatus(reason, 'error');
      }
      showInputRow(false);
      try { ws.removeEventListener('message', onMsg); } catch {}
    }, { once:true });
  };

  window.clearLang = function(){
    setConsole('');
    try { window.termWS?.close(); } catch {}
    window.termWS = null;
    window.wsRunInFlight = false;
    clearCMarkers();
    showInputRow(false);
    stopDots();
  };

  // expose for your shell buttons
  window.run   = window.runLang;
  window.clear = window.clearLang;
})();
</script>







  
</body>
</html>
