<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>polycode | C</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="icon" href="./assets/logo.png" />
  <link rel="stylesheet" href="./css/shell.css" />
  <link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>
  <meta name="color-scheme" content="dark light" />

  <style>
    /* Input row look */
    #consoleRow span{ background:transparent!important; padding:0!important; border-radius:0!important }
    #consoleInput{
      display:inline-block; min-width:5ch; background:transparent; border:0; outline:0; box-shadow:none;
      caret-color: currentColor; user-select:text; -webkit-user-modify: read-write-plaintext-only;
    }
    #consoleInput:focus{ outline:0 }
    #consoleInput::selection{ background:rgba(255,255,255,.15) }

    .btn[disabled], .btn.attn[disabled]{ animation:none!important }
    .pane-foot .msg{ white-space:nowrap }
    .panel .pane-head{ display:flex; align-items:center }

    /* Output pane: single pinned horizontal scrollbar */
    #output{ position:relative; padding:0; }
    /* Vertical scroller only; hide native horizontal bar */
    #outV{
      position:absolute; inset:0 0 16px 0; /* leave room for pinned h-scroll */
      overflow-y:auto; overflow-x:hidden; padding:12px;
      -webkit-overflow-scrolling:touch;
    }
    /* This wrapper moves horizontally via transform so we don't need a native h-scroll */
    #outH{ position:relative; display:inline-block; transform:translateX(0); will-change:transform; }
    #jconsole{
      margin:0; white-space:pre !important; word-break:normal !important; overflow-wrap:normal !important;
      line-height:1.25;
    }
    #hbar{
      position:absolute; left:0; right:0; bottom:0; height:16px;
      overflow-x:auto; overflow-y:hidden;
    }
    #hbarInner{ height:1px; } /* width set by JS */

    /* Complexity modal tokens (shared with Java) */
    .pc-modal { position: fixed; inset: 0; display: none; z-index: 1000; }
    .pc-modal[aria-hidden="false"] { display:block; }
    .pc-modal__backdrop{ position:absolute; inset:0; background:rgba(0,0,0,.45); }
    .pc-modal__dialog{ position:relative; margin:5vh auto; max-width:800px; background:var(--panel, #111); color:inherit; border:1px solid rgba(255,255,255,.1); border-radius:14px; box-shadow:0 20px 50px rgba(0,0,0,.35); padding:14px; }
    .pc-modal__header{ display:flex; align-items:center; justify-content:space-between; }
    .pc-modal__close{ background:transparent; border:0; font-size:22px; cursor:pointer; }
    .pc-modal__body{ max-height:60vh; overflow:auto; }
    .pc-modal__footer{ display:flex; justify-content:flex-end; gap:8px; }
    .cx-summary{ display:grid; grid-template-columns:1fr 1fr; gap:10px; margin:6px 0 10px; }
    .cx-table{ width:100%; border-collapse: collapse; font:13px/1.4 ui-monospace, Menlo, Consolas, monospace; }
    .cx-table th, .cx-table td{ border-bottom:1px solid rgba(127,127,127,.25); padding:6px 8px; vertical-align: top; }
    .cx-table th{ text-align:left; position:sticky; top:0; background:inherit; }
    .cx-notes{ opacity:.9; font-size:12px; margin-top:8px; }

    @media (prefers-reduced-motion: no-preference) {
      @keyframes pc-pulse-brief { 0%{transform:scale(1)} 40%{transform:scale(1.08)} 100%{transform:scale(1)} }
      .btn-pulse { animation: pc-pulse-brief 0.9s ease-out; }
    }
  </style>
</head>

<body class="page-fade">
  <!-- Header -->
  <header class="site-header">
    <div class="brand-wrap">
      <div class="brand-grid">
        <img src="./assets/PC-Logo.png" alt="polycode" class="brand-logo" loading="lazy" decoding="async" />
        <div class="brand-title2">polycode</div>
        <div class="brand-tagline2">learn<span class="dot">.</span>code<span class="dot">.</span>execute</div>
      </div>
    </div>

    <nav class="site-nav">
      <a href="./index.html">Home</a>
      <a href="./about.html">About</a>
      <a href="./contact.html">Contact</a>
    </nav>
  </header>

  <!-- App -->
  <div class="stage">
    <div class="app">
      <!-- LEFT -->
      <section class="panel left" id="leftPanel">
        <div class="pane-head">
          <select id="langSelect" class="select" aria-label="Choose language" onchange="location.href=this.value">
            <option value="./index-c.html" selected>C</option>
            <option value="./index-cpp.html">C++</option>
            <option value="./index-web.html">HTML/CSS/JS</option>
            <option value="./index-java.html">Java</option>
            <option value="./index-sql.html">SQL (MySQL/SQLite)</option>
          </select>
        </div>
        <div class="pane-body"><div id="leftContent" style="margin-top:12px;"></div></div>
        <div class="pane-foot"><span class="msg" id="leftFoot">About C</span></div>
      </section>

      <div class="v-resize"><div id="dragLeft"></div></div>

      <!-- CENTER (Editor) -->
      <section class="panel center" id="centerPanel">
        <div class="pane-head">
          <button id="themeToggle" class="btn theme-btn" title="Toggle theme" aria-label="Toggle theme">
            <svg viewBox="0 0 24 24" id="themeIcon"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg>
          </button>

          <span class="title" id="centerTitle" style="margin-left:8px;">C – Editor | Polycode</span>

          <div class="right-controls" style="margin-left:auto; display:flex; gap:8px; align-items:center;">
            <button id="btnSaveFile" class="btn" title="Save (Ctrl/Cmd + S)" aria-label="Save">
              <svg viewBox="0 0 24 24">
                <path d="M17 3H5a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V7l-4-4zm-5 16a3 3 0 1 1 0-6 3 3 0 0 1 0 6zm3-10H6V5h9v4z" fill="currentColor"/>
              </svg>
            </button>

            <button id="btnSharePdf" class="btn" title="Share PDF" aria-label="Share PDF">
              <svg viewBox="0 0 24 24">
                <path d="M4 12v8a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-8h-2v8H6v-8H4zm8-10-5.5 5.5L8.91 9 11 6.91V16h2V6.91L15.09 9l2.41-1.5L12 2z" fill="currentColor"/>
              </svg>
            </button>

            <button id="btnRun" class="btn primary attn" title="Execute (Click or Press F9)" aria-label="Run">
              <svg viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg>
            </button>
          </div>
        </div>

        <div id="editor"></div>

        <div class="pane-foot"><span class="msg" id="centerFoot">Ready for Execution</span></div>
      </section>

      <div class="v-resize right"><div id="dragRight"></div></div>

      <!-- RIGHT (Console) -->
      <section class="panel right" id="rightPanel">
        <div class="pane-head">
          <span class="title">C – Console | Polycode</span>
          <div class="right-controls" style="margin-left:auto; display:flex; align-items:center;">
            <button id="btnComplexity" class="btn" title="Analyze Time & Space" aria-label="Complexity" disabled>
              <svg viewBox="0 0 24 24" width="18" height="18" aria-hidden="true">
                <circle cx="12" cy="12" r="7" fill="none" stroke="currentColor" stroke-width="2"/>
                <path d="M9 9.5c.9-1 2-1.5 3-1.5s2.1.5 3 1.5" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
              </svg>
              <span class="sr-only">Complexity</span>
            </button>
            <button id="btnReset" class="btn" title="Reset (Click or Press F10)" aria-label="Reset">
              <svg viewBox="0 0 24 24"><path d="M12 6v3l4-4-4-4v3C7.58 4 4 7.58 4 12s3.58 8 8 8a8 8 0 007.39-4.91l-1.85-.77A6 6 0 1112 6z"/></svg>
            </button>
          </div>
        </div>

        <div id="output" class="screen-dim">
          <!-- Scrollable output + pinned bottom h-scroll -->
          <div id="outV">
            <div id="outH">
              <pre id="jconsole" class="console"></pre>

              <!-- Inline input row -->
              <div id="consoleRow" style="display:none; margin-top:0; gap:4px; align-items:baseline; font:14px/1.4 ui-monospace, Menlo, Consolas, monospace;">
                <span id="consolePrefix"></span>
                <span id="consoleInput" contenteditable="true" spellcheck="false"></span>
              </div>
            </div>
          </div>
          <div id="hbar"><div id="hbarInner"></div></div>
        </div>

        <div class="pane-foot"><span class="msg" id="rightFoot">Waiting for Execution</span></div>
      </section>
    </div>
  </div>

  <!-- Collapser chevron -->
  <div class="chevron-tab" id="chevronTab" title="Toggle left panel">
    <svg viewBox="0 0 24 24"><path d="M9.29 6.71a1 1 0 011.42 0L15 11l-4.29 4.29a1 1 0 11-1.42-1.42L12.17 11 9.29 8.12a1 1 0 010-1.41z"/></svg>
  </div>

  <!-- Footer -->
  <footer class="site-footer">
    <div class="footer-grid">
      <div class="footer-left">
        <img src="./assets/logo.png" alt="Edifica" class="footer-logo" loading="lazy" decoding="async" />
        <div class="txt">
          <span class="powered">powered by edifica</span>
          <span class="subline">education<span class="dot">.</span>consultation<span class="dot">.</span>assistance</span>
          <div class="siteurl"><a href="https://www.edifica.in" target="_blank" rel="noopener">www.edifica.in</a></div>
        </div>
      </div>
      <div class="footer-center">
        <span class="label">Follow us</span>
        <a class="social" href="https://facebook.com/edifica.facebook" target="_blank" rel="noopener" aria-label="Facebook" title="Facebook">
          <svg viewBox="0 0 24 24" width="18" height="18"><path d="M22 12.07C22 6.48 17.52 2 11.93 2S2 6.48 2 12.07c0 5.01 3.66 9.16 8.44 9.93v-7.03H7.9v-2.9h2.54V9.41c0-2.5 1.49-3.89 3.77-3.89 1.09 0 2.24.2 2.24.2v2.47h-1.26c-1.24 0-1.63.77-1.63 1.56v1.88h2.78l-.44 2.9h-2.34v7.03C18.34 21.23 22 17.08 22 12.07z"/></svg>
        </a>
        <a class="social" href="https://instagram.com/edifica.ig" target="_blank" rel="noopener" aria-label="Instagram" title="Instagram">
          <svg viewBox="0 0 24 24" width="18" height="18"><path d="M7 2h10a5 5 0 0 1 5 5v10a5 5 0 0 1-5 5H7a5 5 0 0 1-5-5V7a5 5 0 0 1 5-5zm5 5a5 5 0 1 0 0 10 5 5 0 0 0 0-10zm6.5-.5a1.5 1.5 0 1 0 0 3 1.5 1.5 0 0 0 0-3zM12 9.5A2.5 2.5 0 1 1 9.5 12 2.5 2.5 0 0 1 12 9.5z"/></svg>
        </a>
        <a class="social" href="https://youtube.com/@edifica.youtube" target="_blank" rel="noopener" aria-label="YouTube" title="YouTube">
          <svg viewBox="0 0 24 24" width="18" height="18"><path d="M23.5 6.2a3 3 0 0 0-2.1-2.1C19.4 3.5 12 3.5 12 3.5s-7.4 0-9.4.6A3 3 0 0 0 .5 6.2 31.7 31.7 0 0 0 0 12a31.7 31.7 0 0 0 .6 5.8 3 3 0 0 0 2.1 2.1c.4-1.9.6-3.9.6-5.8 0-1.9-.2-3.9-.6-5.8zM9.6 15.5V8.5L16 12l-6.4 3.5z"/></svg>
        </a>
      </div>
      <div class="footer-right">
        <a href="./privacy.html">Privacy Policy</a>
        <a href="./terms.html">Terms &amp; Conditions</a>
        <a href="./legal.html">Legal Information</a>
      </div>
    </div>
  </footer>

  <!-- Scripts -->
  <script src="https://cdn.jsdelivr.net/npm/monaco-editor@0.45.0/min/vs/loader.min.js" defer></script>
  <script src="./js/shell.js" defer></script>

  <!-- Page script -->
  <script>
    const SAMPLE_C =
`#include <stdio.h>

int main(){
    int n;
    printf("Enter a number: ");
    if (scanf("%d", &n) != 1) return 0;
    printf("Square = %d\\n", n*n);
    return 0;
}`;

    /* ===== Bootstrap ===== */
    window.bootstrap = async function(){
      await window.PolyShell.initMonaco({ value: SAMPLE_C, language: 'c' });
      
      window.PolyShell.setStatus('Ready', 'ok');
      window.PolyShell.loadLeftContent?.('c');
      window.setComplexityEnabled?.(false);
    };



    // ---- DEBUG: who is touching our markers?
(function () {
  const orig = monaco.editor.setModelMarkers;
  monaco.editor.setModelMarkers = function (model, owner, markers) {
    if (owner === 'c-compile') {
      const n = Array.isArray(markers) ? markers.length : 0;
      console.log(`[markers] owner=${owner} count=${n}`,
        '\n' + new Error().stack.split('\n').slice(2, 12).join('\n'));
      // debugger; // <- uncomment to break when they are cleared
    }
    return orig.apply(this, arguments);
  };
})();


    
    /* ===== Monaco marker helpers ===== */
let __markerGen = 0;

function setEditorMarkers(list){
  if (!window.monaco || !window.editor) return;
  const model = window.editor.getModel(); if (!model) return;

  // remember which “generation” put these markers on this model
  model.__pcMarkerGen = __markerGen;

  const items = Array.isArray(list) ? list : (list ? [list] : []);
  const markers = items.map(e => {
    const lineCount = model.getLineCount();
    let line = Math.max(1, Math.min(lineCount, Number(e?.line) || 1));
    const maxCol = model.getLineMaxColumn(line);
    let start = Math.max(1, Math.min(maxCol - 1, Number(e?.col) || 1));
    const end = Math.min(maxCol, start + 1);
    const sev = ({warning:1,info:2,hint:3}[String(e?.sev).toLowerCase()] ?? 8); // Error
    return { startLineNumber: line, endLineNumber: line, startColumn: start, endColumn: end,
             message: String(e?.msg || 'Error'), severity: sev };
  });
  window.monaco.editor.setModelMarkers(model, 'c-compile', markers);
}

function clearEditorMarkers(){
  if (!window.monaco || !window.editor) return;
  const model = window.editor.getModel(); if (!model) return;

  // only clear if we’re still on the same generation that set them
  if (model.__pcMarkerGen === __markerGen) {
    window.monaco.editor.setModelMarkers(model, 'c-compile', []);
  }
}




    function findAllGccErrors(text){
  if (!text) return [];
  const clean = text.replace(/\x1B\[[0-9;]*[A-Za-z]/g, '');
  const out = [];
  let m;

  // path/to/file.c:LINE:COL: error: MSG
  const re1 = /(?:^|\n)(?:.*?)(?:^|[\/\\])([^\/\\\n]+?\.(?:c|h)):(\d+)(?::(\d+))?\s*:\s*(?:fatal\s+)?error\s*:\s*([^\n]+)/mg;

  while ((m = re1.exec(clean))) out.push({ file:m[1], line:+m[2], col:m[3]?+m[3]:1, msg:m[4] });

  // <stdin>:LINE:COL: error: MSG
  const re2 = /(?:^|\n)<stdin>:(\d+)(?::(\d+))?\s*:\s*(?:fatal\s+)?error\s*:\s*([^\n]+)/mg;
  while ((m = re2.exec(clean))) out.push({ file:'<stdin>', line:+m[1], col:m[2]?+m[2]:1, msg:m[3] });

  // file.c:LINE: error: MSG  (no column)
  const re3 = /(?:^|\n)([^:\n]+?\.(?:c|h)):(\d+):\s*(?:fatal\s+)?error:\s*([^\n]+)/mg;
  while ((m = re3.exec(clean))) out.push({ file:m[1], line:+m[2], col:1, msg:m[3] });

  // de-dupe by (line,msg) to avoid repeats as log grows
  const seen = new Set();
  return out.filter(e => {
    const k = `${e.line}|${e.col}|${e.msg}`;
    if (seen.has(k)) return false; seen.add(k); return true;
  });
}

 function findFirstGccError(text){
  if (!text) return null;
  const clean = text.replace(/\x1B\[[0-9;]*[A-Za-z]/g, '');

  // path/to/main.c:LINE:COL: error: MSG   (gcc/clang)
  let m = /(?:^|\n)(?:.*?)(?:^|\/)([^\/\n]+?\.(?:c|h)):(\d+)(?::(\d+))?\s*:\s*(?:fatal\s+)?error\s*:\s*([^\n]+)/m.exec(clean);
  if (m) return { file:m[1], line:Number(m[2]), col:m[3] ? Number(m[3]) : 1, msg:m[4] };

  // <stdin>:LINE:COL: error: MSG          (some toolchains)
  m = /(?:^|\n)<stdin>:(\d+)(?::(\d+))?\s*:\s*(?:fatal\s+)?error\s*:\s*([^\n]+)/m.exec(clean);
  if (m) return { file:'<stdin>', line:Number(m[1]), col:m[2] ? Number(m[2]) : 1, msg:m[3] };

  // filename.c:LINE: error: MSG           (no column)
  m = /(?:^|\n)([^:\n]+?\.(?:c|h)):(\d+):\s*(?:fatal\s+)?error:\s*([^\n]+)/m.exec(clean);
  if (m) return { file:m[1], line:Number(m[2]), col:1, msg:m[3] };

  // no reliable line -> no marker
  return null;
}



    /* ===== Console helpers ===== */
    function refreshHWidth(){
      const outV = document.getElementById('outV');
      const outH = document.getElementById('outH');
      const inner = document.getElementById('hbarInner');
      if (outV && outH && inner){
        inner.style.width = Math.max(outH.scrollWidth, outV.clientWidth) + 'px';
      }
    }
    function setConsole(text){
      const el = document.getElementById('jconsole'); if (!el) return;
      el.textContent = text || '';
      document.getElementById('outV')?.scrollTo({ top: 1e9 });
      refreshHWidth();
    }
    function termWrite(t){
      const el = document.getElementById('jconsole'); if (!el) return;
      el.textContent += t;
      document.getElementById('outV')?.scrollTo({ top: 1e9 });
      refreshHWidth();
    }
    // Keep the content horizontally in sync with the pinned scrollbar
    (function hsync(){
      const outV = document.getElementById('outV');
      const outH = document.getElementById('outH');
      const hbar = document.getElementById('hbar');
      if (!outV || !outH || !hbar) return;
      const sync = ()=>{ outH.style.transform = 'translateX(' + (-hbar.scrollLeft) + 'px)'; };
      hbar.addEventListener('scroll', sync);
      window.addEventListener('resize', ()=>{ refreshHWidth(); sync(); });
      refreshHWidth(); sync();
    })();

    /* ===== Input row ===== */
    function focusConsoleInput(){
      const el = document.getElementById('consoleInput'); if (!el) return;
      el.focus();
      const r = document.createRange(); r.selectNodeContents(el); r.collapse(false);
      const s = window.getSelection(); s.removeAllRanges(); s.addRange(r);
    }
    function showInputRow(show){
      const row = document.getElementById('consoleRow');
      const pre = document.getElementById('jconsole');
      const prefix = document.getElementById('consolePrefix');
      if (!row || !pre || !prefix) return;

      row.style.display = show ? 'flex' : 'none';

      if (show){
        const txt = pre.textContent; const i = txt.lastIndexOf('\n'); const tail = txt.slice(i+1);
        if (tail && !/^\s*$/.test(tail)){ prefix.textContent = tail + ' '; pre.textContent = txt.slice(0, i+1); }
        else { prefix.textContent = ''; }
        focusConsoleInput();

        window.PolyShell?.setRunnerPhase?.('waiting_input', { detail: getCountdownText?.() });
        window.PolyShell?.setStatus('Waiting for User Input...', 'busy');
        startStatusDots('Waiting for User Input');
        startInputCountdown(inputWaitMs);
        window.PolyShell?.startInputTicker?.(getCountdownText, 500);
      } else {
        if (prefix.textContent){ pre.textContent += prefix.textContent; prefix.textContent = ''; }
        stopInputCountdown();
        window.PolyShell?.stopInputTicker?.();
        if (window.wsRunInFlight){
          window.PolyShell?.setRunnerPhase?.('running');
          window.PolyShell?.setStatus('Executing...', 'busy');
          startStatusDots('Executing');
        } else {
          stopStatusDots();
        }
      }
    }

    /* ===== Complexity button ===== */
    function setComplexityEnabled(on){
      const b = document.getElementById('btnComplexity'); if (!b) return;
      const was = b.disabled; b.disabled = !on;
      if (on && was && !b.dataset.pulsedOnce){ b.classList.add('btn-pulse'); b.dataset.pulsedOnce='1'; setTimeout(()=>b.classList.remove('btn-pulse'), 1000); }
    }
    window.setComplexityEnabled = setComplexityEnabled;

    /* ===== Input wait + status dots (like Java) ===== */
    let __inputDeadline = 0, __inputCountdownTimer = null, __statusTimer = null;
    let __statusBase  = 'Executing';
    let inputWaitMs   = 5 * 60 * 1000; // 5 min

    function getCountdownText(){
      if (!__inputDeadline) return '';
      const ms = Math.max(0, __inputDeadline - Date.now());
      const s  = Math.floor(ms/1000);
      const mm = String(Math.floor(s/60)).padStart(2,'0');
      const ss = String(s%60).padStart(2,'0');
      return ` — ${mm}:${ss}`;
    }
    function startInputCountdown(ms){
      stopInputCountdown();
      __inputDeadline = Date.now() + Math.max(0, Number(ms)||0);
      __inputCountdownTimer = setInterval(()=>{
        const el = document.getElementById('statusDots');
        if (el) el.textContent = __statusBase + getCountdownText();
      }, 500);
    }
    function stopInputCountdown(){
      __inputDeadline = 0;
      if (__inputCountdownTimer){ clearInterval(__inputCountdownTimer); __inputCountdownTimer=null; }
    }
    function startStatusDots(baseText){
      stopStatusDots();
      __statusBase = baseText || 'Executing';
      let dots = 0;
      __statusTimer = setInterval(()=>{
        dots = (dots+1)%4;
        const el = document.getElementById('statusDots');
        const txt = __statusBase + '.'.repeat(dots) + getCountdownText();
        if (el) el.textContent = txt; else window.PolyShell?.setStatus(txt,'busy');
      }, 400);
    }
    function stopStatusDots(){ if (__statusTimer){ clearInterval(__statusTimer); __statusTimer=null; } }

    /* ===== Runner overlay ===== */
    function showRunnerOverlay(msg='Connecting to C runner…', pct=10, hint='Opening WebSocket…'){
      const ov=document.getElementById('runnerOverlay'), bar=document.getElementById('runnerBar'),
            m=document.getElementById('runnerMsg'), h=document.getElementById('runnerHint');
      if (!ov||!bar||!m||!h) return;
      ov.style.display='flex'; m.textContent=msg; h.textContent=hint;
      bar.style.width=Math.max(5,Math.min(100,Math.floor(pct)))+'%';
    }
    function updateRunnerOverlay({msg,pct,hint}){
      const m=document.getElementById('runnerMsg'), h=document.getElementById('runnerHint'),
            bar=document.getElementById('runnerBar');
      if (msg&&m) m.textContent=msg; if (hint&&h) h.textContent=hint;
      if (typeof pct==='number' && bar) bar.style.width=Math.max(5,Math.min(100,Math.floor(pct)))+'%';
    }
    function hideRunnerOverlay(){ const ov=document.getElementById('runnerOverlay'); if (ov) ov.style.display='none'; }

    /* ===== Heartbeat ===== */
    let hbInterval=null, hbTimeout=null;
    function startHeartbeat(ws){
      stopHeartbeat();
      hbInterval=setInterval(()=>{
        try{
          if (ws.readyState===1){
            ws.send(JSON.stringify({type:'ping'}));
            clearTimeout(hbTimeout);
            hbTimeout=setTimeout(()=>{ console.warn('Runner heartbeat missed'); },5000);
          }
        }catch{}
      },25000);
    }
    function stopHeartbeat(){ if (hbInterval){ clearInterval(hbInterval); hbInterval=null; } if (hbTimeout){ clearTimeout(hbTimeout); hbTimeout=null; } }

    /* ===== C runner endpoints ===== */
    const C_API_BASE = 'https://polycode-cc.onrender.com';
    const C_WS_URL   = 'wss://polycode-cc.onrender.com/cc';

    async function prepare(){
      const code = window.editor ? window.editor.getValue() : '';
      const files = [{ path:'main.c', content: code }];
      const res = await fetch(C_API_BASE + '/api/cc/prepare', {
        method:'POST', headers:{ 'Content-Type':'application/json' },
        body: JSON.stringify({ lang:'c', files, entry:'main.c', output:'a.out' })
      });
      if (!res.ok) throw new Error('Prepare failed: ' + res.status);
      return res.json();
    }
    function codeNeedsInput(src){ return /\b(scanf|fscanf|fgets|getchar|gets|getline|read)\b\s*\(/i.test(src); }

    /* ===== Flags & finalization ===== */
    let __cFlags = {
      sawCompileErr:false, sawRuntimeErr:false, exitCode:null,
      sawAnyOutput:false, inputProvided:false, needsStdin:false
    };
    let __aggLog = '';
    const stripAnsi = (s)=> s.replace(/\x1B\[[0-9;]*[A-Za-z]/g, '');

    function markFirstErrorFromLog(){
      //const e = findFirstGccError(stripAnsi(__aggLog));
      //if (e){ setEditorMarker(e.line, e.msg, e.col); }
      setEditorMarkers(findAllGccErrors(stripAnsi(__aggLog)));
    }
    function finishUI(){ window.setRunUI?.(false); }

    function finalizeStatus(){
  stopHeartbeat();
  stopStatusDots();
  stopInputCountdown();
  window.PolyShell?.stopInputTicker?.();
  window.wsRunInFlight = false;
  showInputRow(false);
  hideRunnerOverlay();

  const cleanLog = stripAnsi(__aggLog || (document.getElementById('jconsole')?.textContent || ''));
  const hasCompileErr =
  __cFlags.sawCompileErr ||
  /(^|\n)[^:\n]+:\d+(?::\d+)?:\s*(?:fatal\s+)?error\s*:/i.test(cleanLog);
  const hasRuntimeErr = __cFlags.sawRuntimeErr
    || /undefined reference|segmentation fault|floating point exception|abort|stack smashing|fault|core dumped/i.test(cleanLog);

  // Decide outcome
  if (__cFlags.exitCode !== null) {
    const ok = (__cFlags.exitCode === 0) && !hasCompileErr && !hasRuntimeErr;
    if (ok) {
      window.PolyShell?.setRunnerPhase?.('success');
      window.PolyShell.setStatus('Execution Success', 'ok');
      clearEditorMarkers();
      setComplexityEnabled(true);
    } else {
      window.PolyShell?.setRunnerPhase?.('error');
      window.PolyShell.setStatus(hasCompileErr ? 'Compilation Failed' : 'Execution Failed', 'error');
      markFirstErrorFromLog();
      setComplexityEnabled(false);
    }
    window.setRunUI?.(false);  // <-- close AFTER status/phase is set
    return;
  }

  // No explicit exit code — infer
  if (hasCompileErr) {
    window.PolyShell?.setRunnerPhase?.('error');
    window.PolyShell.setStatus('Compilation Failed', 'error');
    markFirstErrorFromLog();
    setComplexityEnabled(false);
  } else if (hasRuntimeErr) {
    window.PolyShell?.setRunnerPhase?.('error');
    window.PolyShell.setStatus('Execution Failed', 'error');
    setComplexityEnabled(false);
  } else if (__cFlags.needsStdin && !__cFlags.inputProvided) {
    window.PolyShell?.setRunnerPhase?.('error');
    window.PolyShell.setStatus('Execution ended (no input / timeout)', 'error');
    setComplexityEnabled(false);
  } else {
    window.PolyShell?.setRunnerPhase?.('success');
    window.PolyShell.setStatus('Execution Finished', 'ok');
    clearEditorMarkers();
    setComplexityEnabled(true);
  }

  window.setRunUI?.(false);    // <-- close AFTER phase/status
}


    /* ===== Send input on Enter, clear "waiting" ===== */
    document.addEventListener('keydown',(e)=>{
      const el = document.getElementById('consoleInput');
      if (!el || el.offsetParent===null) return;
      if (e.target!==el) return;
      if (e.key==='Enter'){
        e.preventDefault();
        const line = el.textContent + '\n';
        if (window.termWS && window.termWS.readyState===1 && window.wsRunInFlight){
          try{ window.termWS.send(JSON.stringify({type:'stdin', data: line})); }catch{}
        }
        termWrite(line);
        el.textContent='';
        __cFlags.inputProvided = true;

        window.PolyShell?.setRunnerPhase?.('running');
        window.PolyShell.setStatus('Executing…','busy');
        stopInputCountdown(); window.PolyShell?.stopInputTicker?.();
        startStatusDots('Executing');
        showInputRow(false);
      }
    }, true);

    /* ===== Main run ===== */
window.runLang = async function(){
  window.setRunUI?.(true);
  __markerGen++;        // new run, invalidate old clears
clearEditorMarkers(); // optional: clear immediately for a fresh run
  setConsole(''); document.getElementById('outV')?.classList.remove('error');
  setComplexityEnabled(false); clearEditorMarkers();
  try{ window.termWS?.close(); }catch{}
  window.termWS = null; window.wsRunInFlight = false;

  stopStatusDots(); stopInputCountdown(); window.PolyShell?.stopInputTicker?.();
  __cFlags = { sawCompileErr:false, sawRuntimeErr:false, exitCode:null, sawAnyOutput:false, inputProvided:false, needsStdin:false };
  __aggLog = '';

  window.PolyShell?.setRunnerPhase?.('running');
  window.PolyShell.setStatus('Compiling…','busy');
  showRunnerOverlay('Compiling C program…', 12, 'Sending source to backend…');

  // --- compile / prepare ---
  let prep;
  try{
    updateRunnerOverlay({ pct:28, hint:'Building with gcc…' });
    prep = await prepare();
    updateRunnerOverlay({ pct:45, hint:'Checking build artifacts…' });
  }catch(e){
    updateRunnerOverlay({ pct:100, hint:'Compilation failed' });
    setTimeout(hideRunnerOverlay, 300);
    setConsole((e && e.message) || 'Prepare failed');
    __aggLog += String((e && e.message) || '');
    window.PolyShell?.setRunnerPhase?.('error');
    window.PolyShell.setStatus('Compilation Failed','error');
    setComplexityEnabled(false);
    finishUI();
    // IMPORTANT: reject so shell.js catch() runs
    throw new Error('compile_failed');
  }

  if (!prep || !prep.ok || !prep.token){
    const log = (prep && (prep.compileLog||prep.stderr||prep.stdout)) || 'Compilation failed.';
    setConsole((log||'').trim());
    __aggLog += String(log||'');
    setEditorMarkers(findAllGccErrors(__aggLog));
    updateRunnerOverlay({ pct:100, hint:'Compilation failed' });
    setTimeout(hideRunnerOverlay, 300);
    window.PolyShell?.setRunnerPhase?.('error');
    window.PolyShell.setStatus('Compilation Failed','error');
    setComplexityEnabled(false);
    finishUI();
    // IMPORTANT: reject so shell.js catch() runs
    throw new Error('compile_failed');
  }

  const token = prep.token;
  updateRunnerOverlay({ msg:'Connecting to C runner…', pct:65, hint:'Opening WebSocket…' });
  const ws = new WebSocket(C_WS_URL + '?token=' + encodeURIComponent(token));
  window.termWS = ws; window.wsRunInFlight = true;
  window.PolyShell?.setRunnerPhase?.('running');
  window.PolyShell.setStatus('Running (interactive)…','busy');

  __cFlags.needsStdin = codeNeedsInput(window.editor ? window.editor.getValue() : '');
  if (__cFlags.needsStdin) showInputRow(true);

  ws.addEventListener('open', ()=>{
    updateRunnerOverlay({ pct:95, hint:'Finalizing…' });
    setTimeout(hideRunnerOverlay, 150);
    startHeartbeat(ws);
  });

  // Helper to evaluate final outcome using your flags + log
  function computeOutcome(){
  const cleanLog = stripAnsi(__aggLog || (document.getElementById('jconsole')?.textContent || ''));

  const hasCompileErr =
  __cFlags.sawCompileErr ||
  /(^|\n)[^:\n]+:\d+(?::\d+)?:\s*(?:fatal\s+)?error\s*:/i.test(cleanLog);

  const hasRuntimeErr = __cFlags.sawRuntimeErr
    || /undefined reference|segmentation fault|floating point exception|abort|stack smashing|fault|core dumped/i.test(cleanLog);

  // If backend gave an explicit exit code, use it.
  if (__cFlags.exitCode !== null) {
    const ok = (__cFlags.exitCode === 0) && !hasCompileErr && !hasRuntimeErr;
    return { ok, reason: ok ? '' : (hasCompileErr ? 'compile_failed' : 'runtime_failed') };
  }

  // Infer just like finalizeStatus()
  if (hasCompileErr)   return { ok:false, reason:'compile_failed' };
  if (hasRuntimeErr)   return { ok:false, reason:'runtime_failed' };
  if (__cFlags.needsStdin && !__cFlags.inputProvided)
                       return { ok:false, reason:'no_input' };

  // No explicit exit, no errors detected -> treat as success.
  return { ok:true, reason:'' };
}

  // Return a promise that resolves/rejects on end (like Java)
  return await new Promise((resolve, reject) => {
    let settled = false;
    const settle = (ok, reason) => {
      if (settled) return; settled = true;
      if (ok) resolve(); else reject(new Error(reason || 'run_failed'));
    };

    ws.addEventListener('message',(ev)=>{
      const raw = String(ev.data || '');
      let msg = null; try{ msg = JSON.parse(raw); }catch{}

      if (msg && typeof msg==='object' && msg.type){
        if (msg.type==='stdout'){ termWrite(msg.data||''); __aggLog += stripAnsi(String(msg.data||'')); if ((msg.data||'').trim()) __cFlags.sawAnyOutput = true; return; }
        if (msg.type==='stderr'){ termWrite(msg.data||''); __aggLog += stripAnsi(String(msg.data||'')); __cFlags.sawRuntimeErr = true; return; }
        if (msg.type==='compileErr'){ termWrite(msg.data||''); __aggLog += stripAnsi(String(msg.data||'')); __cFlags.sawCompileErr = true; 
                                     setEditorMarkers(findAllGccErrors(__aggLog)); return; }
        if (msg.type==='stdin_req'){ showInputRow(true); return; }
        if (msg.type==='exit'){
          __cFlags.exitCode = Number(msg.code);
          finalizeStatus();                // your UI logic + setRunUI(false)
          const { ok, reason } = computeOutcome();
          settle(ok, reason);
          return;
        }
        return;
      }

      // Plain text fallback (keep your immediate detection)
      termWrite(raw);
      const clean = stripAnsi(raw);
      __aggLog += clean;
      if (clean.trim()) __cFlags.sawAnyOutput = true;

     const errs = findAllGccErrors(__aggLog);
if (errs.length) {
  __cFlags.sawCompileErr = true;
  setEditorMarkers(errs);
  window.PolyShell?.setRunnerPhase?.('error');
  window.PolyShell.setStatus('Compilation Failed', 'error');
}

      if (/undefined reference|segmentation fault|floating point exception|abort|stack smashing|fault|core dumped/i.test(clean)) {
        __cFlags.sawRuntimeErr = true;
      }

      const ex = clean.match(/\b(?:exit\s*code|EXIT)\s*[:=]\s*(-?\d+)/i);
      if (ex) __cFlags.exitCode = Number(ex[1]);
    });

    ws.addEventListener('error', ()=>{ termWrite('\n[connection error]\n'); });

    ws.addEventListener('close', () => {
      // If exit wasn't received, still finalize + decide
      finalizeStatus();
      const { ok, reason } = computeOutcome();
      settle(ok, reason);
    }, { once:true });
  });
};


    /* ===== Reset ===== */
    window.clearLang = function(){
      setConsole('');
      try{ window.termWS?.close(); }catch{}
      window.termWS=null; window.wsRunInFlight=false;
      showInputRow(false); setComplexityEnabled(false);
      stopStatusDots(); stopInputCountdown(); window.PolyShell?.stopInputTicker?.();
      hideRunnerOverlay(); clearEditorMarkers(); finishUI();
      window.PolyShell.setStatus('Ready','ok');
    };

    /* ===== Startup ===== */
    (function startWhenReady(){
      function start(){
        if (!window.PolyShell){
          const id = setInterval(()=>{ if (window.PolyShell){ clearInterval(id); window.bootstrap(); } }, 25);
          setTimeout(()=>clearInterval(id), 3000);
          return;
        }
        window.bootstrap();
      }
      if (document.readyState==='loading'){ document.addEventListener('DOMContentLoaded', start, { once:true }); }
      else { start(); }
    })();
  </script>

  <!-- Runner connecting overlay -->
  <div id="runnerOverlay" style="position: fixed; inset: 0; display: none; align-items: center; justify-content: center; background: rgba(0,0,0,0.45); z-index: 9999;">
    <div style="min-width: 280px; max-width: 420px; padding: 16px 18px; border-radius: 12px; background: var(--panel, #111); color: inherit; box-shadow: 0 6px 24px rgba(0,0,0,0.35); font: 14px/1.4 ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto;">
      <div id="runnerMsg" style="font-weight:600; margin-bottom:8px;">Connecting to C runner…</div>
      <div style="height:8px; background: rgba(255,255,255,0.15); border-radius: 999px; overflow:hidden;">
        <div id="runnerBar" style="height:100%; width:18%; background: currentColor; opacity:0.9;"></div>
      </div>
      <div id="runnerHint" style="margin-top:8px; opacity:0.8;">Warming up backend…</div>
    </div>
  </div>

  <!-- Complexity modal -->
  <div class="pc-modal" id="cxModal" aria-hidden="true">
    <div class="pc-modal__backdrop" data-close></div>
    <div class="pc-modal__dialog">
      <div class="pc-modal__header">
        <div class="pc-modal__title">Time Complexity (C)</div>
        <button class="pc-modal__x" data-close aria-label="Close">×</button>
      </div>
      <div class="pc-modal__body">
        <div class="cx-summary" id="cxSummary"></div>
        <hr/>
        <table class="cx-table" id="cxTable"><thead><tr><th>Line</th><th>Type</th><th>Complexity</th><th>Reason</th></tr></thead><tbody></tbody></table>
        <div class="cx-notes" id="cxNotes"></div>
      </div>
      <div class="pc-modal__footer"><button class="btn" data-close>Close</button></div>
    </div>
  </div>
  <script>
    document.addEventListener('click', (e)=>{ const t=e.target; if (t && t.matches('[data-close]')){ document.getElementById('cxModal')?.setAttribute('aria-hidden','true'); } });
    document.getElementById('btnComplexity')?.addEventListener('click', ()=>{
      document.getElementById('cxModal')?.setAttribute('aria-hidden','false');
      window.PolyShell?.setStatus('Analyzing…'); setTimeout(()=> window.PolyShell?.setStatus('Ready','ok'), 400);
    });
  </script>

  <script src="./js/complexityc.js" defer></script>
</body>
</html>
