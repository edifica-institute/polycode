<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>polycode | C</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="icon" href="./assets/logo.png" />
  <link rel="stylesheet" href="./css/shell.css" />
  <link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>
  <meta name="color-scheme" content="dark light" />

  <style>
    /* Match the Java console input UX */
    #consoleRow span {
      background: transparent !important;
      padding: 0 !important;
      border-radius: 0 !important;
    }
    #consoleInput {
      display: inline-block;
      min-width: 5ch;
      background: transparent;
      border: 0;
      outline: 0;
      box-shadow: none;
      caret-color: currentColor;
      user-select: text;
      -webkit-user-modify: read-write-plaintext-only;
    }
    #consoleInput:focus { outline: 0; }
    #consoleInput::selection { background: rgba(255, 255, 255, 0.15); }

    .pane-foot .msg { white-space: nowrap; }
    .panel .pane-head { display:flex; align-items:center; }
  </style>

 <script>
  window.RUNNER_HTTP = 'https://polycode-java.onrender.com';
  window.RUNNER_WS   = 'wss://polycode-java.onrender.com/term-c';
</script>

  
</head>

<body class="page-fade">
  <!-- Header -->
  <header class="site-header">
    <div class="brand-wrap">
      <div class="brand-grid">
        <img src="./assets/PC-Logo.png" alt="polycode" class="brand-logo" loading="lazy" decoding="async" />
        <div class="brand-title2">polycode</div>
        <div class="brand-tagline2">learn<span class="dot">.</span>code<span class="dot">.</span>execute</div>
      </div>
    </div>

    <nav class="site-nav">
      <a href="./index.html">Home</a>
      <a href="./about.html">About</a>
      <a href="./contact.html">Contact</a>
    </nav>
  </header>

  <!-- App -->
  <div class="stage">
    <div class="app">
      <!-- LEFT panel -->
      <section class="panel left" id="leftPanel">
        <div class="pane-head">
          <select
            id="langSelect"
            class="select"
            aria-label="Choose language"
            onchange="location.href=this.value"
          >
            <option value="./index-sql.html">SQL (MySQL/SQLite)</option>
            <option value="./index-web.html">HTML/CSS/JS</option>
            <option value="./index-java.html">Java</option>
            <option value="./index-c.html" selected>C</option>
          </select>
        </div>
        <div class="pane-body">
          <div id="leftContent" style="margin-top:12px;"></div>
        </div>
        <div class="pane-foot">
          <span class="msg" id="leftFoot">About C</span>
        </div>
      </section>

      <!-- RESIZER between left and center -->
      <div class="v-resize">
        <div id="dragLeft"></div>
      </div>

      <!-- CENTER panel (Editor) -->
      <section class="panel center" id="centerPanel">
        <div class="pane-head">
          <button id="themeToggle" class="btn theme-btn" title="Toggle theme" aria-label="Toggle theme">
            <svg viewBox="0 0 24 24" id="themeIcon">
              <path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z" />
            </svg>
          </button>
          <span class="title" id="centerTitle" style="margin-left:8px;">C – Editor | Polycode</span>
          <div class="right-controls" style="margin-left:auto; display:flex; gap:8px; align-items:center;">
            <button id="btnSaveFile" class="btn" title="Save (Ctrl/Cmd + S)" aria-label="Save">
              <svg viewBox="0 0 24 24">
                <path d="M17 3H5a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V7l-4-4zm-5 16a3 3 0 1 1 0-6 3 3 0 0 1 0 6zm3-10H6V5h9v4z" fill="currentColor" />
              </svg>
            </button>

            <button id="btnRun" class="btn primary attn" title="Execute (Click or Press F9)" aria-label="Run">
              <svg viewBox="0 0 24 24"><path d="M8 5v14l11-7z" /></svg>
            </button>
          </div>
        </div>

        <div id="editor"></div>

        <div class="pane-foot">
          <span class="msg" id="centerFoot">Ready for Execution</span>
        </div>
      </section>

      <!-- RESIZER between center and right -->
      <div class="v-resize right">
        <div id="dragRight"></div>
      </div>

      <!-- RIGHT panel (Console) -->
      <section class="panel right" id="rightPanel">
        <div class="pane-head">
          <span class="title">C – Console | Polycode</span>
          <div class="right-controls" style="margin-left:auto; display:flex; align-items:center;">
            <button id="btnReset" class="btn" title="Reset (Click or Press F10)" aria-label="Reset">
              <svg viewBox="0 0 24 24"><path d="M12 6v3l4-4-4-4v3C7.58 4 4 7.58 4 12s3.58 8 8 8a8 8 0 007.39-4.91l-1.85-.77A6 6 0 1112 6z" /></svg>
            </button>
          </div>
        </div>

        <div id="output" class="screen-dim" style="padding:12px;">
          <!-- Output -->
          <pre id="cconsole" class="console" style="margin:0; white-space:pre-wrap;"></pre>

          <!-- Input row (only when needed) -->
          <div id="consoleRow"
               style="display:none; margin-top:0; gap:4px; align-items:baseline; font:14px/1.4 ui-monospace, Menlo, Consolas, monospace;">
            <span id="consolePrefix"></span>
            <span id="consoleInput" contenteditable="true" spellcheck="false"></span>
          </div>
        </div>

        <div class="pane-foot">
          <span class="msg" id="rightFoot">Waiting for Execution</span>
        </div>
      </section>
    </div>
  </div>

  <!-- Floating chevron for collapse/expand -->
  <div class="chevron-tab" id="chevronTab" title="Toggle left panel">
    <svg viewBox="0 0 24 24">
      <path d="M9.29 6.71a1 1 0 011.42 0L15 11l-4.29 4.29a1 1 0 11-1.42-1.42L12.17 11 9.29 8.12a1 1 0 010-1.41z" />
    </svg>
  </div>

  <!-- Footer -->
  <footer class="site-footer">
    <div class="footer-grid">
      <div class="footer-left">
        <img src="./assets/logo.png" alt="Edifica" class="footer-logo" loading="lazy" decoding="async" />
        <div class="txt">
          <span class="powered">powered by edifica</span>
          <span class="subline">education<span class="dot">.</span>consultation<span class="dot">.</span>assistance</span>
          <div class="siteurl">
            <a href="https://www.edifica.in" target="_blank" rel="noopener">www.edifica.in</a>
          </div>
        </div>
      </div>

      <div class="footer-center">
        <span class="label">Follow us</span>
        <a class="social" href="https://facebook.com/edifica.facebook" target="_blank" rel="noopener" aria-label="Facebook" title="Facebook">
          <svg viewBox="0 0 24 24" width="18" height="18"><path d="M22 12.07C22 6.48 17.52 2 11.93 2S2 6.48 2 12.07c0 5.01 3.66 9.16 8.44 9.93v-7.03H7.9v-2.9h2.54V9.41c0-2.5 1.49-3.89 3.77-3.89 1.09 0 2.24.2 2.24.2v2.47h-1.26c-1.24 0-1.63.77-1.63 1.56v1.88h2.78l-.44 2.9h-2.34v7.03C18.34 21.23 22 17.08 22 12.07z" /></svg>
        </a>
        <a class="social" href="https://instagram.com/edifica.ig" target="_blank" rel="noopener" aria-label="Instagram" title="Instagram">
          <svg viewBox="0 0 24 24" width="18" height="18"><path d="M7 2h10a5 5 0 0 1 5 5v10a5 5 0 0 1-5 5H7a5 5 0 0 1-5-5V7a5 5 0 0 1 5-5zm5 5a5 5 0 1 0 0 10 5 5 0 0 0 0-10zm6.5-.5a1.5 1.5 0 1 0 0 3 1.5 1.5 0 0 0 0-3zM12 9.5A2.5 2.5 0 1 1 9.5 12 2.5 2.5 0 0 1 12 9.5z" /></svg>
        </a>
        <a class="social" href="https://youtube.com/@edifica.youtube" target="_blank" rel="noopener" aria-label="YouTube" title="YouTube">
          <svg viewBox="0 0 24 24" width="18" height="18"><path d="M23.5 6.2a3 3 0 0 0-2.1-2.1C19.4 3.5 12 3.5 12 3.5s-7.4 0-9.4.6A3 3 0 0 0 .5 6.2 31.7 31.7 0 0 0 0 12a31.7 31.7 0 0 0 .6 5.8 3 3 0 0 0 2.1 2.1c.4-1.9.6-3.9.6-5.8zM9.6 15.5V8.5L16 12l-6.4 3.5z" /></svg>
        </a>
      </div>

      <div class="footer-right">
        <a href="./privacy.html">Privacy Policy</a>
        <a href="./terms.html">Terms &amp; Conditions</a>
        <a href="./legal.html">Legal Information</a>
      </div>
    </div>
  </footer>

  <!-- Monaco + Shell -->
  <script src="https://cdn.jsdelivr.net/npm/monaco-editor@0.45.0/min/vs/loader.min.js" defer></script>
  <script src="./js/shell.js" defer></script>

  <!-- Page script -->
  <script>
  (function(){
    /* --- Sample C in the editor --- */
    const SAMPLE_C =
`#include <stdio.h>
#include <stdlib.h>

int main(void){
  printf("Enter N: ");
  fflush(stdout);
  int n;
  if (scanf("%d", &n) != 1) return 0;

  int *a = malloc((size_t)n * sizeof(int));
  if (!a){ perror("malloc"); return 1; }
  for (int i=0;i<n;i++) a[i] = (i+1)*(i+1);

  FILE *fp = fopen("out.txt","w");
  if (!fp){ perror("fopen"); free(a); return 1; }
  for (int i=0;i<n;i++) fprintf(fp, "%d\\n", a[i]);
  fclose(fp);

  long sum = 0; int *p = a;
  for (int i=0;i<n;i++,p++) sum += *p;
  printf("Sum: %ld\\n", sum);

  free(a);
  return 0;
}`;

    /* --- Hook up editor --- */
    window.bootstrap = async function bootstrap(){
      await window.PolyShell.initMonaco({ value: SAMPLE_C, language: 'c' });
      window.PolyShell.setStatus('Ready', 'ok');
      window.PolyShell.loadLeftContent('c'); // if you have /content/c.html
    };

    // ---------- Console helpers ----------
    function setConsole(text){
      const el = document.getElementById('cconsole');
      if (el){
        el.textContent = text || '';
        document.getElementById('output')?.scrollTo({ top: 1e9 });
      }
    }
    function termWrite(t){
      const el = document.getElementById('cconsole');
      if (el){
        el.textContent += t;
        document.getElementById('output')?.scrollTo({ top: 1e9 });
      }
    }

    // ---------- Input row helpers ----------
    function focusConsoleInput(){
      const el = document.getElementById('consoleInput');
      if (!el) return;
      el.focus();
      const r = document.createRange();
      r.selectNodeContents(el);
      r.collapse(false);
      const s = window.getSelection();
      s.removeAllRanges();
      s.addRange(r);
    }
    function showInputRow(show){
      const row    = document.getElementById('consoleRow');
      const pre    = document.getElementById('cconsole');
      const prefix = document.getElementById('consolePrefix');
      if (row) row.style.display = show ? 'flex' : 'none';

      if (show){
        const txt  = pre.textContent;
        const i    = txt.lastIndexOf('\\n');
        const tail = txt.slice(i + 1);
        if (tail && !/^\\s*$/.test(tail)){
          prefix.textContent = tail + ' ';
          pre.textContent = txt.slice(0, i + 1);
        } else {
          prefix.textContent = '';
        }
        window.PolyShell?.setStatus('Waiting for User Input...', 'busy');
        __statusBase = 'Waiting for User Input';
        startStatusDots(__statusBase);
      } else {
        if (prefix.textContent){
          pre.textContent += prefix.textContent;
          prefix.textContent = '';
        }
      }
    }

    // ---------- Status dots like Java ----------
    let __statusTimer = null;
    let __statusBase  = '';
    function startStatusDots(baseText){
      stopStatusDots();
      __statusBase = baseText || 'Running';
      let dots = 0;
      __statusTimer = setInterval(() => {
        dots = (dots + 1) % 4;
        window.PolyShell?.setStatus(__statusBase + '.'.repeat(dots), 'busy');
      }, 400);
    }
    function stopStatusDots(){
      if (__statusTimer){ clearInterval(__statusTimer); __statusTimer = null; }
    }

    // ---------- Monaco markers for GCC ----------
    function clearCMarkers(){
      if (!window.monaco || !window.editor) return;
      const model = window.editor.getModel();
      if (model) window.monaco.editor.setModelMarkers(model, 'gcc', []);
    }
    function setCMarkers(diagnostics){
      if (!Array.isArray(diagnostics) || !window.monaco || !window.editor) return;
      const model = window.editor.getModel();
      if (!model) return;
      const markers = diagnostics.map(d => ({
        startLineNumber: d.line || 1,
        endLineNumber:   d.line || 1,
        startColumn:     1,
        endColumn:       Math.max(1, model.getLineMaxColumn(d.line || 1)),
        message:         String(d.message || 'error'),
        severity:        /warn/i.test(d.severity) ? window.monaco.MarkerSeverity.Warning : window.monaco.MarkerSeverity.Error
      }));
      window.monaco.editor.setModelMarkers(model, 'gcc', markers);
    }

    // ---------- Runner endpoints ----------
  // Make a global right away so DevTools can use it
window.POLY = window.POLY || {};

// Runner endpoints: default to same origin, allow overrides
const RUNNER_HTTP = window.RUNNER_HTTP || window.location.origin;
const RUNNER_WS =
  window.RUNNER_WS ||
  ((location.protocol === 'https:' ? 'wss://' : 'ws://') + location.host + '/term-c');


// keep them mirrored on POLY so DevTools can see current values
window.POLY = window.POLY || {};
window.POLY.RUNNER_HTTP = RUNNER_HTTP;
window.POLY.RUNNER_WS   = RUNNER_WS;






    
    async function compileC(src){
      const files = [{ path:'main.c', content: src }];
      const resp  = await fetch(RUNNER_HTTP + '/api/c/prepare', {
        method:'POST', headers:{ 'Content-Type':'application/json' },
        body: JSON.stringify({ files })
      });
      const data = await resp.json().catch(() => ({}));
      return { ok: resp.ok, data };
    }

    window.POLY.compileC = compileC;
window.POLY.openCWS  = openCWS;


    
    // ---------- WebSocket run (JSON protocol like Java) ----------
    window.termWS = window.termWS || null;
    window.wsRunInFlight = window.wsRunInFlight || false;

    async function openCWS(token, maxTotalMs = 20000){
      const start = Date.now();
      const steps = [300, 700, 1200, 2000, 3200];
      let attempt = 0;
      while (Date.now() - start < maxTotalMs){
        attempt++;
        const perTimeout = Math.min(7000, maxTotalMs - (Date.now() - start));
        const ws = await new Promise((resolve) => {
          let done = false, timer, w;
          function finish(v){ if(!done){ done = true; clearTimeout(timer); resolve(v);} }
          try { const url = token ? (RUNNER_WS + '?token=' + encodeURIComponent(token)) : RUNNER_WS;
w = new WebSocket(url); } catch { return resolve(null); }
          timer = setTimeout(() => { try{ w?.close(); }catch{} finish(null); }, perTimeout);
          w.onopen  = () => finish(w);
          w.onerror = () => {/* close follows */};
          w.onclose = () => finish(null);
        });
        if (ws && ws.readyState === 1) return ws;
        const wait = steps[Math.min(attempt-1, steps.length-1)];
        await new Promise(r => setTimeout(r, wait));
      }
      return null;
    }

    // Send input on Enter
    document.addEventListener('keydown', (e) => {
      const el = document.getElementById('consoleInput');
      if (!el || el.offsetParent === null) return;
      if (e.target !== el) return;
      if (e.key === 'Enter'){
        e.preventDefault();
        const line = el.textContent;
        const pre  = document.getElementById('cconsole');
        const pref = document.getElementById('consolePrefix');
        if (pref && pref.textContent){
          pre.textContent += pref.textContent;
          pref.textContent = '';
        }
        termWrite(line + '\n');
        el.textContent = '';
        try {
          if (window.termWS && window.termWS.readyState === 1 && window.wsRunInFlight){
            window.termWS.send(JSON.stringify({ type:'stdin', data: line + '\n' }));
          }
        } catch {}
        focusConsoleInput();
      }
    }, { capture:true });

    // ---------- Hook into shell.js API ----------
    window.runLang = async function runLang(codeOverride){
       window.run = window.runLang;
     clearCMarkers();
setConsole('');

const code = window.editor ? window.editor.getValue() : '';
window.PolyShell.setStatus('Running (interactive)…', 'busy');
startStatusDots('Running');

const ws = await openCWS(null, 20000); // no token
if (!ws){
  stopStatusDots();
  window.PolyShell.setStatus('Runner unavailable — please retry', 'error');
  return;
}
window.termWS = ws;
window.wsRunInFlight = true;

const onMsg = (ev) => {
  try {
    const m = JSON.parse(String(ev.data));
    if (m.type === 'stdout')        termWrite(m.data);
    else if (m.type === 'stderr')   termWrite(m.data);
    else if (m.type === 'stdin_req'){ showInputRow(true); focusConsoleInput(); }
    else if (m.type === 'diagnostics'){ setCMarkers(m.data || []); }
    else if (m.type === 'exit'){
      stopStatusDots(); window.wsRunInFlight = false; showInputRow(false);
      window.PolyShell.setStatus(m.code === 0 ? 'Execution Success' : 'Execution Failed', m.code === 0 ? 'ok' : 'error');
      try { ws.removeEventListener('message', onMsg); } catch {}
    }
  } catch {}
};
ws.addEventListener('message', onMsg);

// send files to compile+run
const files = [{ path:'main.c', content: code }];

// small tick prevents any race with server’s message handler
termWrite('⏳ compiling…\n');
await new Promise(r => setTimeout(r, 15));

try {
  ws.send(JSON.stringify({ type: 'start', files }));
} catch {}



      
      
      ws.addEventListener('close', () => {
        try { ws.removeEventListener('message', onMsg); } catch {}
        stopStatusDots();
        if (window.wsRunInFlight){
          window.wsRunInFlight = false;
          window.PolyShell.setStatus('Runner disconnected', 'error');
        }
        showInputRow(false);
      }, { once:true });
    };

    window.clearLang = function (){
      setConsole('');
      try { window.termWS?.close(); } catch {}
      window.termWS = null;
      window.wsRunInFlight = false;
      clearCMarkers();
      const row = document.getElementById('consoleRow');
      if (row) row.style.display = 'none';
      const prefix = document.getElementById('consolePrefix');
      if (prefix) prefix.textContent = '';
      stopStatusDots();
    };

   window.POLY.run   = window.runLang;
window.POLY.clear = window.clearLang;

    // Start after shell is ready
    (function startWhenReady(){
      function start(){
        if (!window.PolyShell){
          const id = setInterval(() => {
            if (window.PolyShell){ clearInterval(id); window.bootstrap(); }
          }, 25);
          setTimeout(() => clearInterval(id), 3000);
          return;
        }
        window.bootstrap();
      }
      if (document.readyState === 'loading'){
        document.addEventListener('DOMContentLoaded', start, { once:true });
      } else {
        start();
      }
    })();

  })();
  </script>
</body>
</html>
